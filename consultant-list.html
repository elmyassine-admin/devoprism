<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultant 360 View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://unpkg.com/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; }
        
        /* Select2 Filter Styles */
        .select2-container .select2-selection--multiple { min-height: 42px !important; border-color: #d1d5db; border-radius: 0.5rem; padding-top: 4px; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice { background-color: #4f46e5; border-color: #4338ca; color: white; padding: 2px 8px; font-size: 0.875rem; border-radius: 0.375rem; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove { color: rgba(255,255,255,0.7); margin-right: 4px; }
        #loading-overlay { transition: opacity 0.3s ease-in-out; }
        
        #view-controls button:disabled {
            background-color: #4f46e5;
            color: white;
            cursor: default;
        }
        
        /* General Views */
        .compare-table th, .compare-table td { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
        .compare-table th { text-align: left; background-color: #f9fafb; border-bottom-width: 2px; font-weight: 600; }
        .compare-table .consultant-col { min-width: 200px; white-space: nowrap; }
        .compare-table tr:last-child td { border-bottom: none; }

        .consultant-card { background-color: #ffffff; border: 1px solid #e5e7eb; transition: all 0.2s ease-in-out; }
        .consultant-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.07); border-color: #4f46e5; }
        .card-kpi-item { background-color: #f9fafb; padding: 6px 10px; border-radius: 6px; }
        .story-section > summary { font-size: 1rem; font-weight: 600; cursor: pointer; padding: 0.75rem 0; display: flex; justify-content: space-between; align-items: center; }
        .story-section > summary::after { content: '+'; font-size: 1.25rem; font-weight: 300; transition: transform 0.2s; }
        .story-section[open] > summary::after { transform: rotate(45deg); }
        .story-section .content { padding-bottom: 1rem; }
        .project-entry { padding-left: 1rem; border-left: 2px solid #e5e7eb; position: relative; }
        .project-entry::before { content: ''; position: absolute; left: -6px; top: 4px; width: 10px; height: 10px; border-radius: 50%; background-color: #a5b4fc; }
        .btn-gradient { background-image: linear-gradient(to right, #f8485e, #a344b5); color: white; }
        .btn-gradient:hover { opacity: 0.9; }
        .feature-item.dragging { opacity: 0.5; background: #f0f0f0; }
        .insights-nav-link { cursor: pointer; }
        .insights-nav-link.active { border-color: #4f46e5; color: #4f46e5; }
        .insights-sub-tab-content { display: none; }
        .insights-sub-tab-content.active { display: block; }
        .chart-control-btn { background-color: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe; }
        .chart-control-btn.active { background-color: #4f46e5; color: #ffffff; border-color: #4f46e5; }
        #insights-view .story-section { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 0.5rem 1.5rem; margin-bottom: 1.5rem; }
        #insights-view .story-section[open] { background-color: #ffffff; }
        #insights-view .story-section summary { font-size: 1.25rem; }
        #insights-view .story-section .content { padding-top: 1rem; border-top: 1px solid #e5e7eb; margin-top: 0.75rem; }
        
        /* Recommender View Styles */
        .requirement-card { border-left: 4px solid #4f46e5; }
        .recommender-output-section h3 { border-bottom: 2px solid #4f46e5; }
        .remove-requirement-btn { font-size: 2rem; line-height: 1; }
        .requirement-card-summary { cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .requirement-card-summary::-webkit-details-marker { display: none; }
        .requirement-card-summary .icon { transition: transform 0.2s; }
        details[open] .requirement-card-summary .icon { transform: rotate(180deg); }

        /* Timeline View Styles */
        #gantt-chart-container { 
            overflow: auto; 
            height: calc(100vh - 290px);
            scrollbar-width: thin; 
            scrollbar-color: #a7a7a7 #f1f1f1;
            border: 1px solid #e5e7eb;
        }
        .gantt-grid { display: grid; grid-template-columns: 320px 1fr; min-width: 2400px; }
        .gantt-labels { position: sticky; left: 0; z-index: 20; background-color: #ffffff; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .gantt-timeline-header, .gantt-header { position: sticky; top: 0; z-index: 15; background-color: #ffffff; }
        .gantt-header { display: flex; align-items: center; height: 50px; border-bottom: 2px solid #e5e7eb; }
        .gantt-header-months { display: grid; grid-auto-columns: 1fr; text-align: center; }
        .gantt-month-label { border-left: 1px solid #e5e7eb; padding: 0.5rem; }
        .gantt-group-summary { cursor: pointer; background-color: #f1f5f9; border-bottom: 1px solid #e5e7eb; height: 40px; display: flex; align-items: center; padding: 0 0.5rem; font-weight: bold; color: #334155; }
        .gantt-group-summary:hover { background-color: #e2e8f0; }
        .gantt-label-row, .timeline-row { display: grid; grid-template-columns: subgrid; grid-column: 1 / -1; }
        .gantt-label-cell { border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; padding: 0.5rem; }
        .timeline-row { border-bottom: 1px solid #e5e7eb; position: relative; }
        .gantt-row-odd { background-color: #f8fafc; }
        .gantt-row-highlight { background-color: #fefce8 !important; }
        .gantt-group-summary .arrow { transition: transform 0.2s; }
        .gantt-group-summary.collapsed .arrow { transform: rotate(-90deg); }
        .today-line { position: absolute; top: 0; bottom: 0; border-left: 2px dashed #f8485e; z-index: 12; }
        .today-label { position: absolute; top: -25px; transform: translateX(-50%); white-space: nowrap; background-image: linear-gradient(to right, #f8485e, #a344b5); color: white; padding: 3px 8px; border-radius: 999px; font-size: 11px; font-weight: bold; }
        .gantt-bar { position: absolute; border-radius: 999px; overflow: hidden; white-space: nowrap; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; transition: all 0.2s ease-in-out; padding-left: 0.75rem; padding-right: 0.75rem; z-index: 2; border: 1px solid rgba(0,0,0,0.1); }
        .gantt-bar:hover { filter: brightness(1.1); transform: scale(1.02); z-index: 10; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .gantt-bar-planned { background-color: #60a5fa; color: #1e3a8a; } 
        .gantt-bar-ongoing { background-color: #fb923c; color: #7c2d12; }
        .gantt-bar-completed { background-color: #9ca3af; color: #1f2937; }
        .gantt-bar-vacation { background: repeating-linear-gradient(-45deg, #fca5a5, #fca5a5 5px, #fecaca 5px, #fecaca 10px); color: #991b1b; justify-content: center; } 
        .gantt-bar-available { background-color: #4ade80; position: absolute; top: 0; height: 100%; z-index: 1; opacity: 0.15; border-radius: 0; }
        .hide-completed .gantt-bar-completed, .hide-ongoing .gantt-bar-ongoing, .hide-planned .gantt-bar-planned, .hide-vacation .gantt-bar-vacation, .hide-availability .gantt-bar-available, .text-filter-hidden { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50 p-8 text-center">
        <svg id="loading-spinner" class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-message" class="mt-4 text-lg font-medium text-gray-700">Connecting to Google Sheet...</p>
    </div>
    
    <div id="image-modal" class="fixed inset-0 z-40 hidden items-center justify-center bg-black bg-opacity-80">
        <div class="relative p-4 max-w-5xl max-h-full">
            <button id="modal-close-btn" class="absolute top-2 right-2 text-white text-3xl font-bold opacity-75 hover:opacity-100">&times;</button>
            <img id="modal-image" src="" alt="Consultant Profile" class="max-w-full max-h-[90vh] rounded-lg shadow-lg">
        </div>
    </div>

    <div id="recommender-info-modal" class="fixed inset-0 z-40 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <button id="modal-info-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <div class="flex items-center gap-4 mb-6">
                <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                        <path fill-rule="evenodd" d="M9.778 21.034A11.25 11.25 0 0 1 8.25 3.755a11.25 11.25 0 0 1 11.962 12.016A4.5 4.5 0 0 0 18 19.5h-3.111a.75.75 0 0 1-.745-.691 15.163 15.163 0 0 0-2.365-5.084 1.5 1.5 0 0 0-2.333-2.333c-1.758 1.12-3.23 2.658-4.32 4.417a.75.75 0 0 1-1.12.223 11.25 11.25 0 0 1-.223-1.12c1.758-2.613 4.14-4.553 6.96-5.694a.75.75 0 0 1 .84.84 15.16 15.16 0 0 0 2.222 4.174 6 6 0 0 1 8.216 2.476A11.216 11.216 0 0 1 12.33 21.75a.75.75 0 0 1-.44-.108 11.19 11.19 0 0 1-2.112-.608Z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">How the Team Recommender Works</h2>
                    <p class="text-gray-500">A transparent, data-driven approach to building optimal teams.</p>
                </div>
            </div>
            
            <div class="space-y-6 text-gray-600">
                <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-2">Step 1: Candidate Filtering</h3>
                    <p class="text-sm">For each role, the system creates a shortlist of qualified candidates. A consultant must meet <strong class="font-semibold">all</strong> of the following criteria:</p>
                    <ul class="list-disc list-inside mt-2 pl-2 space-y-1 text-sm">
                        <li><strong>Availability:</strong> Must be 'Active - Stable' and available before your project start date (no vacation conflicts).</li>
                        <li><strong>Experience & Grade:</strong> Must meet the minimum years of experience and match the selected Grade.</li>
                        <li><strong>Skills Match:</strong> Must possess <strong class="font-semibold">all</strong> "Required Capabilities".</li>
                        <li><strong>Value Proposition Fit:</strong> Must meet the minimum percentage fit for <strong class="font-semibold">all</strong> "Required Value Propositions".</li>
                        <li><strong>Client/Project History:</strong> Project history must match any keywords provided.</li>
                    </ul>
                </div>

                <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-2">Step 2: Match Scoring</h3>
                    <p class="text-sm">Each shortlisted candidate is given a "Match Score" to rank their individual fit:</p>
                    <ul class="list-disc list-inside mt-2 pl-2 space-y-1 text-sm">
                        <li><strong>Base Score:</strong> Starts at <strong>100 points</strong>.</li>
                        <li><strong>Experience Bonus:</strong> Gets <strong>+5 points</strong> for each year of experience *above* the minimum requirement.</li>
                        <li><strong>Client History Bonus:</strong> A significant <strong>+50 points</strong> is awarded for matching project history keywords.</li>
                    </ul>
                </div>

                <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-2">Step 3: Team Optimization</h3>
                    <p class="text-sm">The system analyzes all possible full-team combinations to find the best synergies:</p>
                    <ul class="list-disc list-inside mt-2 pl-2 space-y-1 text-sm">
                        <li><strong>Total Match Score:</strong> The individual match scores of all team members are added together.</li>
                        <li><strong>Cohesion Bonus (✨):</strong> The "secret sauce". For each past project two consultants have worked on together, a <strong>+20 point</strong> bonus is added to the team's total score.</li>
                        <li><strong>Final Ranking:</strong> Teams are ranked by their final score (Total Match Score + Cohesion Bonus).</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="sticky top-0 z-30 bg-slate-50 shadow-sm">
        <div class="w-full mx-auto px-4 md:px-8">
            <header class="py-6 rounded-lg bg-gradient-to-r from-[#f8485e] to-purple-600 text-white flex items-center justify-between">
                <div class="flex items-start gap-x-4 pl-6">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10 text-white opacity-90 flex-shrink-0 mt-1">
                        <path d="M4.5 6.375a4.125 4.125 0 1 1 8.25 0 4.125 4.125 0 0 1-8.25 0ZM14.25 8.625a3.375 3.375 0 1 1 6.75 0 3.375 3.375 0 0 1-6.75 0ZM1.5 19.125a7.125 7.125 0 0 1 14.25 0v.003l-.001.119a.75.75 0 0 1-.363.63 13.067 13.067 0 0 1-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 0 1-.364-.63l-.001-.122ZM17.25 19.128l-.001.144a2.25 2.25 0 0 1-.53 1.467 4.873 4.873 0 0 1-6.425-3.32.75.75 0 0 1 .55-.942 4.873 4.873 0 0 1 6.425 3.32Z" />
                    </svg>
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold">Consultant 360 View</h1>
                        <p class="text-md opacity-90 mt-1">Find and filter our talent pool to identify the right consultants for specific needs.</p>
                        <a href="index.html" class="text-sm text-white opacity-80 hover:opacity-100 hover:underline mt-2 inline-block">&larr; Back to Home</a>
                    </div>
                </div>
                <img src="https://logo.clearbit.com/devoteam.com" alt="Devoteam Logo" class="h-12 w-auto bg-white p-2 rounded-md mr-6" onerror="this.style.display='none'">
            </header>
            <div id="view-controls" class="py-3 flex justify-between items-center bg-slate-50 border-b">
                <div>
                    <span class="isolate inline-flex rounded-md shadow-sm">
                        <button type="button" id="show-list-view" class="relative inline-flex items-center rounded-l-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10" disabled>List View</button>
                        <button type="button" id="show-compare-view" class="relative -ml-px inline-flex items-center bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">Compare Profiles</button>
                        <button type="button" id="show-insights-view" class="relative -ml-px inline-flex items-center bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">Capacity Insights</button>
                        <button type="button" id="show-timeline-view" class="relative -ml-px inline-flex items-center bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">Consultant Timeline</button>
                        <button type="button" id="show-recommender-view" class="relative -ml-px inline-flex items-center rounded-r-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">Team Recommender</button>
                    </span>
                </div>
                <div id="compare-actions" class="hidden">
                    <span id="compare-count" class="text-sm font-medium text-gray-700 mr-3"></span>
                    <button id="compare-now-btn" class="btn-gradient font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Compare Now</button>
                    <button id="clear-comparison-btn" class="ml-2 text-sm text-gray-600 hover:text-indigo-600">Clear</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="w-full mx-auto p-4 md:p-8">
        <div id="main-content">
            <div id="list-view">
                <div class="flex flex-col lg:flex-row gap-6">
                    <aside class="w-full lg:w-1/4 xl:w-1/5">
                        <div class="bg-white p-5 rounded-lg shadow-md sticky top-48"> 
                            <h2 class="text-xl font-bold mb-5 border-b pb-3">Find Talent</h2>
                            
                            <div class="space-y-1">
                                <details class="py-2" open>
                                    <summary class="font-semibold text-gray-700 flex justify-between items-center hover:text-indigo-600 cursor-pointer">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" /></svg>
                                            <span>Primary Filters</span>
                                        </div>
                                        <svg class="w-5 h-5 text-gray-500 transition-transform arrow-down" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </summary>
                                    <div class="pt-4 pl-1 space-y-4">
                                        <div>
                                            <label for="top-globalSearch" class="block text-sm font-medium text-gray-700 mb-1">Global Search</label>
                                            <div class="relative">
                                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                                </div>
                                                <input type="text" id="top-globalSearch" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="Name, skill, client...">
                                            </div>
                                        </div>
                                        <div>
                                            <label for="top-practice" class="block text-sm font-medium text-gray-700 mb-1">Practice</label>
                                            <select id="top-practice" multiple="multiple" class="w-full"></select>
                                        </div>
                                        <div>
                                            <label for="top-office" class="block text-sm font-medium text-gray-700 mb-1">Office</label>
                                            <select id="top-office" multiple="multiple" class="w-full"></select>
                                        </div>
                                    </div>
                                </details>

                                <details class="py-2 border-t" open>
                                    <summary class="font-semibold text-gray-700 flex justify-between items-center hover:text-indigo-600 cursor-pointer">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                            <span>Role & Status</span>
                                        </div>
                                        <svg class="w-5 h-5 text-gray-500 transition-transform arrow-down" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </summary>
                                    <div class="pt-4 pl-1 space-y-4">
                                        <div><label for="sidebar-employmentStatus" class="block text-sm font-medium text-gray-600 mb-1">Employment Status</label><select id="sidebar-employmentStatus" multiple="multiple" class="w-full"></select></div>
                                        <div><label for="grade" class="block text-sm font-medium text-gray-600 mb-1">Grade</label><select id="grade" multiple="multiple" class="w-full"></select></div>
                                        <div><label for="joinDateAfter" class="block text-sm font-medium text-gray-600 mb-1">Joined After</label><input type="date" id="joinDateAfter" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm p-2.5"></div>
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                                <label for="experience" class="text-sm font-medium text-gray-600">Min. Experience</label>
                                                <span id="experienceValue" class="text-sm font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md">0 years</span>
                                            </div>
                                            <input type="range" id="experience" min="0" max="25" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        </div>
                                    </div>
                                </details>

                                <details class="py-2 border-t">
                                    <summary class="font-semibold text-gray-700 flex justify-between items-center hover:text-indigo-600 cursor-pointer">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>
                                            <span>Expertise</span>
                                        </div>
                                        <svg class="w-5 h-5 text-gray-500 transition-transform arrow-down" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </summary>
                                    <div class="pt-4 pl-1 space-y-4">
                                        <div><label for="profileCapabilities" class="block text-sm font-medium text-gray-600 mb-1">Profile Capabilities</label><select id="profileCapabilities" multiple="multiple" class="w-full"></select></div>
                                        <div>
                                            <label for="valueProposition" class="block text-sm font-medium text-gray-600 mb-1">Value Proposition</label>
                                            <select id="valueProposition" multiple="multiple" class="w-full"></select>
                                            <div id="vp-score-filters-container" class="mt-4 space-y-3"></div>
                                        </div>
                                    </div>
                                </details>

                                <details class="py-2 border-t">
                                    <summary class="font-semibold text-gray-700 flex justify-between items-center hover:text-indigo-600 cursor-pointer">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                            <span>Availability</span>
                                        </div>
                                        <svg class="w-5 h-5 text-gray-500 transition-transform arrow-down" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </summary>
                                    <div class="pt-4 pl-1 space-y-4">
                                        <div><label for="availability" class="block text-sm font-medium text-gray-600 mb-1">Available Before</label><input type="date" id="availability" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm p-2.5"></div>
                                    </div>
                                </details>

                                <details class="py-2 border-t">
                                    <summary class="font-semibold text-gray-700 flex justify-between items-center hover:text-indigo-600 cursor-pointer">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>
                                            <span>Project History & Context</span>
                                        </div>
                                        <svg class="w-5 h-5 text-gray-500 transition-transform arrow-down" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </summary>
                                    <div class="pt-4 pl-1 space-y-4">
                                        <div><label for="client" class="block text-sm font-medium text-gray-600 mb-1">Client History</label><select id="client" multiple="multiple" class="w-full"></select></div>
                                        <div><label for="project" class="block text-sm font-medium text-gray-600 mb-1">Project History</label><select id="project" multiple="multiple" class="w-full"></select></div>
                                        <div><label for="manager" class="block text-sm font-medium text-gray-600 mb-1">Direct Manager</label><select id="manager" multiple="multiple" class="w-full"></select></div>
                                    </div>
                                </details>

                                <div class="pt-4 border-t">
                                    <button id="resetFilters" class="w-full bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mt-2">Reset All Filters</button>
                                </div>
                            </div>
                        </div>
                    </aside>
                    <main class="w-full lg:w-3/4 xl:w-4/5">
                        <section id="kpi-section" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4"></section>
                        <section id="consultant-list-section">
                            <div id="consultant-list" class="space-y-6"></div>
                            <div id="no-results" class="hidden text-center py-16 bg-white rounded-lg shadow-md">
                                <h3 class="mt-2 text-lg font-medium text-gray-900">No Consultants Found</h3>
                                <p class="mt-1 text-sm text-gray-500">Try adjusting your filter criteria.</p>
                            </div>
                        </section>
                    </main>
                </div>
            </div>

            <div id="compare-view" class="hidden"></div>
            <div id="insights-view" class="hidden"></div>
            
            <div id="timeline-view" class="hidden">
                <div class="flex flex-col lg:flex-row gap-6">
                    <aside class="w-full lg:w-1/4 xl:w-1/5">
                        <div class="bg-white p-5 rounded-lg shadow-md sticky top-48"> 
                            <h2 class="text-xl font-bold mb-5 border-b pb-3">Filter Timeline</h2>
                            <div class="space-y-1">
                                <details class="py-2" open>
                                    <summary class="font-semibold text-gray-700 flex justify-between items-center hover:text-indigo-600">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                                            <span>People & Teams</span>
                                        </div>
                                        <svg class="w-5 h-5 text-gray-500 transition-transform arrow-down" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </summary>
                                    <div class="pt-4 pl-1 space-y-4">
                                        <div><label for="filter-bu-practice" class="block text-sm font-medium text-gray-600 mb-1">BU - Practice</label><select id="filter-bu-practice" multiple="multiple" class="w-full"></select></div>
                                        <div><label for="filter-manager" class="block text-sm font-medium text-gray-600 mb-1">Direct Manager</label><select id="filter-manager" multiple="multiple" class="w-full"></select></div>
                                        <div><label for="filter-consultant" class="block text-sm font-medium text-gray-600 mb-1">Consultant</label><select id="filter-consultant" multiple="multiple" class="w-full"></select></div>
                                    </div>
                                </details>

                                <details class="py-2 border-t">
                                    <summary class="font-semibold text-gray-700 flex justify-between items-center hover:text-indigo-600">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>
                                            <span>Project Context</span>
                                        </div>
                                        <svg class="w-5 h-5 text-gray-500 transition-transform arrow-down" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </summary>
                                    <div class="pt-4 pl-1 space-y-4">
                                        <div><label for="filter-project" class="block text-sm font-medium text-gray-600 mb-1">Project</label><select id="filter-project" multiple="multiple" class="w-full"></select></div>
                                        <div><label for="filter-client" class="block text-sm font-medium text-gray-600 mb-1">Client</label><select id="filter-client" multiple="multiple" class="w-full"></select></div>
                                    </div>
                                </details>
                                
                                <details class="py-2 border-t">
                                    <summary class="font-semibold text-gray-700 flex justify-between items-center hover:text-indigo-600">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /><path d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                                            <span>Display Options</span>
                                        </div>
                                        <svg class="w-5 h-5 text-gray-500 transition-transform arrow-down" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </summary>
                                    <div class="pt-4 pl-1 space-y-3 text-sm font-medium">
                                        <label class="flex items-center cursor-pointer"><input type="checkbox" value="completed" class="gantt-filter-cb h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked><div class="w-3 h-3 rounded-full bg-gray-400 ml-2 mr-1.5"></div><span class="text-gray-700">Completed</span></label>
                                        <label class="flex items-center cursor-pointer"><input type="checkbox" value="ongoing" class="gantt-filter-cb h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked><div class="w-3 h-3 rounded-full bg-orange-400 ml-2 mr-1.5"></div><span class="text-gray-700">Ongoing</span></label>
                                        <label class="flex items-center cursor-pointer"><input type="checkbox" value="planned" class="gantt-filter-cb h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked><div class="w-3 h-3 rounded-full bg-blue-400 ml-2 mr-1.5"></div><span class="text-gray-700">Planned</span></label>
                                        <label class="flex items-center cursor-pointer"><input type="checkbox" value="vacation" class="gantt-filter-cb h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked><div class="w-3 h-3 rounded-full bg-red-400 ml-2 mr-1.5"></div><span class="text-gray-700">Vacations</span></label>
                                        <label class="flex items-center cursor-pointer"><input type="checkbox" value="availability" class="gantt-filter-cb h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked><div class="w-3 h-3 rounded-full bg-green-400 ml-2 mr-1.5"></div><span class="text-gray-700">Availability</span></label>
                                    </div>
                                </details>

                                <div class="pt-4 border-t">
                                    <button id="resetTimelineFilters" class="w-full bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mt-2">Reset All Filters</button>
                                </div>
                            </div>
                        </div>
                    </aside>
                    <main class="w-full lg:w-3/4 xl:w-4/5">
                        <section class="bg-white rounded-xl shadow-md overflow-hidden">
                            <div id="gantt-chart-container" class="rounded-xl">
                            </div>
                        </section>
                    </main>
                </div>
            </div>

            <div id="recommender-view" class="hidden"></div>
        </div>
        <footer class="text-center p-4 mt-8 border-t text-xs text-gray-500">
            <span>DEV - v3.8</span> &bull; <span id="current-date"></span>
        </footer>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        document.getElementById('current-date').textContent = new Intl.DateTimeFormat('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }).format(new Date());

        document.addEventListener('DOMContentLoaded', async () => {
            const placeholderSVG = '<svg class="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>';
            
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const loadingSpinner = document.getElementById('loading-spinner');
            const consultantList = document.getElementById('consultant-list');
            const noResults = document.getElementById('no-results');
            const kpiSection = document.getElementById('kpi-section');
            const resetBtn = document.getElementById('resetFilters');
            
            const topGlobalSearchInput = document.getElementById('top-globalSearch');
            const topPracticeSelect = $('#top-practice');
            const topOfficeSelect = $('#top-office');
            const sidebarEmploymentStatusSelect = $('#sidebar-employmentStatus');
            const availabilityInput = document.getElementById('availability');
            const experienceInput = document.getElementById('experience');
            const experienceValue = document.getElementById('experienceValue');
            const gradeSelect = $('#grade');
            const clientSelect = $('#client');
            const projectSelect = $('#project');
            const managerSelect = $('#manager');
            const profileCapabilitiesSelect = $('#profileCapabilities');
            const valuePropositionSelect = $('#valueProposition');
            const joinDateAfterInput = document.getElementById('joinDateAfter');
            
            const listView = document.getElementById('list-view'), compareView = document.getElementById('compare-view'), insightsView = document.getElementById('insights-view'), recommenderView = document.getElementById('recommender-view'), timelineView = document.getElementById('timeline-view');

            let allConsultants = [], allProjects = [], filteredConsultants = [], consultantsToCompare = [];
            let lastRequirements = [], lastRecommenderResults = {};
            
            let tenureChartInstance = null;
            let tenureDistChartInstance = null;
            let hiringVolumeChartInstance = null;
            let hiringSeasonalityChartInstance = null;
            let practiceGrowthChartInstance = null;
            let joinerMixChartInstance = null;
            let practiceHeatmapInstance = null;
            
            const ALL_FEATURES = [
                { key: 'practice', label: 'Practice', type: 'text' },
                { key: 'office', label: 'Office', type: 'text' },
                { key: 'totalYrsOfExp', label: 'Total Experience', type: 'text', suffix: ' yrs' },
                { key: 'joinDate', label: 'Join Date', type: 'text' },
                { key: 'tenure', label: 'Service Time', type: 'text' },
                { key: 'employmentStage', label: 'Employment Status', type: 'text' },
                { key: 'availabilityStartDate', label: 'Next Availability', type: 'text' },
                { key: 'lastWorkingDay', label: 'Last Working Day', type: 'text' },
                { key: 'utilizationYTD', label: 'YTD Utilization', type: 'percent' },
                { key: 'directManager', label: 'Direct Manager', type: 'text' },
                { key: 'careerAdvisor', label: 'Career Advisor', type: 'text' },
                { key: 'resumeLink', label: 'Resume', type: 'link' },
                { key: 'vpFit', label: 'Value Proposition Fit', type: 'heatmap' },
                { key: 'capabilities_expert', label: 'Capabilities (Expert)', type: 'pills', level: 'expert' },
                { key: 'capabilities_medium', label: 'Capabilities (Medium)', type: 'pills', level: 'medium' },
                { key: 'capabilities_foundation', label: 'Capabilities (Foundation)', type: 'pills', level: 'foundation' },
            ];
            let selectedCompareFeatures = ['practice', 'totalYrsOfExp', 'availabilityStartDate', 'capabilities_expert'];

            function getDirectImageLink(googleDriveLink) {
                if (!googleDriveLink) return '';
                const regex = /drive\.google\.com\/file\/d\/([^/]+)/;
                const match = googleDriveLink.match(regex);
                if (match && match[1]) {
                    return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w512`;
                }
                return googleDriveLink;
            }
            
            function getHighQualityImageLink(googleDriveLink) {
                 if (!googleDriveLink) return '';
                 const regex = /drive\.google\.com\/file\/d\/([^/]+)/;
                 const match = googleDriveLink.match(regex);
                 if (match && match[1]) {
                     return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1024`;
                 }
                 return googleDriveLink;
            }

            function parseDate(dateStr) {
                if (!dateStr) return null;
                const formats = [
                    /(\d{1,2})\s+([A-Za-z]+)\s+(\d{4})/,
                    /(\d{1,2})\/(\d{1,2})\/(\d{4})/,
                    /(\w{3})\s(\d{4})/,
                    /(\d{4})-(\d{2})-(\d{2})/,
                ];
                for (const regex of formats) {
                    try {
                       const d = new Date(dateStr);
                       if (!isNaN(d.getTime())) return d;
                    } catch (e) { /* ignore parse errors and try next format */ }
                }
                return null;
            }

            function parseProjectHistory(historyString) {
                if (!historyString) return [];
                const projects = [];
                const projectEntries = historyString.split(/\)\s*,\s*/);
                for (let entry of projectEntries) {
                    entry = entry.trim();
                    if (!entry) continue;
                    if (!entry.endsWith(')')) entry += ')';
                    const mainMatch = entry.match(/(.*?)\s*\((.*)\)/);
                    if (!mainMatch || mainMatch.length < 3) continue;
                    const detailsString = mainMatch[2].trim();
                    const detailMatch = detailsString.match(/^([^,]+),\s*([^,]+),\s*(.+? to .+?),\s*([^,]+),\s*([^,]+),\s*([^,]+),\s*([^,]+),\s*([^,]+)$/);
                    if (!detailMatch) continue; 
                    const periodString = detailMatch[3].trim();
                    let startDate = null, endDate = null;
                    if (periodString.includes(' to ')) {
                        const [startStr, endStr] = periodString.split(' to ').map(s => s.trim());
                        startDate = parseDate(startStr);
                        endDate = parseDate(endStr);
                    }
                    projects.push({ project: mainMatch[1].trim(), client: detailMatch[1].trim(), role: detailMatch[2].trim(), period: periodString, duration: detailMatch[4].trim(), drm: detailMatch[5].trim(), bdm: detailMatch[6].trim(), utilization: detailMatch[7].trim(), status: detailMatch[8].trim(), startDate, endDate });
                }
                return projects;
            }

            function parseOpportunities(oppsString) {
                if (!oppsString || !oppsString.trim()) return [];
                
                const opportunities = [];
                const entries = oppsString.split(';').filter(e => e.trim());

                for (const entry of entries) {
                    const match = entry.trim().match(/(.*?)\s*\((.*)\)/);
                    if (!match || match.length < 3) continue;

                    const name = match[1].trim();
                    const details = match[2].split(',').map(d => d.trim());
                    
                    if (details.length >= 5) {
                        const [id, client, classification, status, practice, ...vps] = details;
                        opportunities.push({ name, id, client, classification, status, practice, vps });
                    }
                }
                return opportunities;
            }

            function parseVacations(vacationStr) {
                if (!vacationStr) return [];
                const vacations = [];
                const periods = vacationStr.split(',');
                for (const period of periods) {
                    const dates = period.split(' to ').map(d => d.trim());
                    if (dates.length === 2) {
                        const startDate = parseDate(dates[0]);
                        const endDate = parseDate(dates[1]);
                        if (startDate && endDate) {
                            vacations.push({ start: startDate, end: endDate });
                        }
                    }
                }
                return vacations;
            }

            async function fetchData() {
                const consultantsUrl = 'https://script.google.com/macros/s/AKfycbzWginV6-AEB7SZBWbq9p8EISvMWMYayvrA3tSrasR2yszgGBt6vc_Ho4HU_5s73yKARw/exec';
                
                const controller = new AbortController();
                
                // Change the message after a few seconds to manage user expectations
                const messageTimerId = setTimeout(() => {
                    loadingMessage.textContent = 'This can take a moment as the server wakes up...';
                }, 5000);
                
                // Increased the timeout from 20 to 45 seconds to handle cold starts
                const timeoutId = setTimeout(() => controller.abort(), 45000); 

                try {
                    const response = await fetch(consultantsUrl, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    clearTimeout(messageTimerId);

                    if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                    
                    const rawData = await response.json();
                    
                    let consultantsMapped = rawData.map(row => ({
                        dmeId: row['DME ID'], consultantName: row['Consultant Name'], email: row['Email Address'],
                        imageLink: row['Image Link'],
                        grade: row['Designation'], totalYrsOfExp: parseInt(row['Total Yrs of Exp'], 10) || 0,
                        practice: row['Practice'], directManager: row['Direct Manager'], careerAdvisor: row['Career Advisor'], businessUnit: row['BU'],
                        resumeSummary: row['Resume Summary'], resumeLink: row['Link to Resume'],
                        technicalSkills: row['Technical Skills & Levels'], functionalSkills: row['Functional Skills & Levels'],
                        softSkills: row['Soft Skills & Levels'], certifications: row['Certifications'],
                        profileCapabilities: row['Profile Capabilities'],
                        projectHistoryStr: row['Projects'], 
                        availabilityStartDate: row['Availability Start Date'],
                        utilizationYTD: parseFloat(Object.values(row).find((v, i) => Object.keys(row)[i].toLowerCase().includes('ytd utilization'))) || 0,
                        vacationStr: row['This Year Vacation'], tenure: row['Tenure'],
                        engagedOpportunities: row['Engaged Opportunities'],
                        vpFit: row['VP Fit'],
                        joinDate: row['Join Date'],
                        office: row['Office'],
                        employmentStage: row['Employment Stage'], 
                        resignationDate: row['Resignation Date'],
                        lastWorkingDay: row['Last Working Day (Exit Date)'],
                        consultantPlanning: row['Consultant Planning']
                    }));
                    
                    const seenIdsCheck = new Map();
                    consultantsMapped.forEach(c => {
                        if (c.dmeId && seenIdsCheck.has(c.dmeId)) {
                            const originalConsultant = seenIdsCheck.get(c.dmeId);
                            console.warn(`Duplicate DME ID found: "${c.dmeId}" for consultants "${c.consultantName}" and "${originalConsultant.consultantName}". Please fix the source data. Assigning a temporary ID to prevent UI errors.`);
                            c.dmeId = `${c.dmeId}_dup_${Math.random().toString(36).substr(2, 5)}`; 
                        } else if(c.dmeId) {
                            seenIdsCheck.set(c.dmeId, c);
                        }
                    });
                    
                    const consultants = consultantsMapped;

                    consultants.forEach(c => parseProjectHistory(c.projectHistoryStr).forEach(p => allProjects.push({ ...p, consultantId: c.dmeId })));
                    return { consultants };
                } catch (error) {
                    clearTimeout(timeoutId);
                    clearTimeout(messageTimerId);
                    console.error("Data fetch failed:", error);
                    loadingSpinner.style.display = 'none';
                    if (error.name === 'AbortError') {
                         loadingMessage.innerHTML = `<div class="text-red-600 font-semibold">Error: Connection timed out.</div> <p class="text-sm mt-2 text-gray-600">The Google Sheet is not responding. This could be due to high traffic or an issue with the script. Please try again later.</p>`;
                    } else {
                         loadingMessage.innerHTML = `<div class="text-red-600 font-semibold">Error: Could not load data.</div> <p class="text-sm mt-2 text-gray-600">Please check the Google Apps Script URL, ensure the sheet is published correctly, and that permissions are set to "Anyone with the link".</p><p class="text-xs mt-1 text-gray-500">Details: ${error.message}</p>`;
                    }
                    return { consultants: [] };
                }
            }

            function initializeDashboard(data) {
                allConsultants = data.consultants;
                populateFilters();
                setupEventListeners();

                sidebarEmploymentStatusSelect.val('Active - Stable').trigger('change');
                
                loadingOverlay.style.opacity = '0';
                setTimeout(() => loadingOverlay.style.display = 'none', 300);
            }

            function populateFilters() {
                const clients = new Set(), projects = new Set(), managers = new Set(), profileCaps = new Set(), valuePropositions = new Set();
                const offices = new Set(), employmentStatuses = new Set(), grades = new Set(), practices = new Set();
                
                allConsultants.forEach(c => {
                    if (c.directManager) managers.add(c.directManager);
                    if (c.office) offices.add(c.office);
                    if (c.employmentStage) employmentStatuses.add(c.employmentStage);
                    if (c.grade) grades.add(c.grade);
                    if (c.practice) practices.add(c.practice);

                    (c.profileCapabilities || '').split(';').forEach(s => {
                        const capNameWithLevel = s.trim();
                        if (capNameWithLevel) profileCaps.add(capNameWithLevel);
                    });
                     (c.vpFit || '').split(';').forEach(item => {
                        const match = item.trim().match(/(.*?)\s*\(\d+%\)/);
                        if (match && match[1]) {
                            valuePropositions.add(match[1].trim());
                        }
                    });
                });
                allProjects.forEach(p => { p.client && clients.add(p.client); p.project && projects.add(p.project); });
                
                const createSelect2 = (selector, data, placeholder) => selector.select2({ data: [...data].sort(), placeholder, closeOnSelect: false, width: '100%' });
                
                createSelect2(topPracticeSelect, practices, "Any practice");
                createSelect2(topOfficeSelect, offices, "Any office");
                createSelect2(sidebarEmploymentStatusSelect, employmentStatuses, "Any status");
                createSelect2(managerSelect, managers, "Any manager");
                createSelect2(gradeSelect, grades, "Any grade");
                createSelect2(profileCapabilitiesSelect, profileCaps, "Select capabilities...");
                createSelect2(valuePropositionSelect, valuePropositions, "Select VPs...");
                createSelect2(clientSelect, clients, "Any client");
                createSelect2(projectSelect, projects, "Any project");
            }

            function renderVPScoreFilters() {
                const container = document.getElementById('vp-score-filters-container');
                const selectedVPs = valuePropositionSelect.val() || [];
                container.innerHTML = '';

                if (selectedVPs.length === 0) {
                    applyFilters();
                    return;
                }

                selectedVPs.forEach(vpName => {
                    const filterRow = document.createElement('div');
                    filterRow.className = 'text-sm';
                    const uniqueId = `vp-score-${vpName.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    filterRow.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                            <label for="${uniqueId}" class="text-gray-600 truncate pr-2">${vpName}</label>
                            <span id="${uniqueId}-display" class="font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-md">0%</span>
                        </div>
                        <input type="range" min="0" max="100" value="0"
                               id="${uniqueId}"
                               data-vp-name="${vpName}"
                               class="vp-score-input w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    `;
                    container.appendChild(filterRow);
                });

                document.querySelectorAll('.vp-score-input').forEach(slider => {
                    slider.addEventListener('input', (e) => {
                        const display = document.getElementById(`${e.target.id}-display`);
                        if (display) {
                            display.textContent = `${e.target.value}%`;
                        }
                        applyFilters();
                    });
                });
                applyFilters();
            }

            function setupEventListeners() {
                const viewControls = document.getElementById('view-controls');
                const showTimelineViewBtn = document.getElementById('show-timeline-view');
                
                $('select').not('#valueProposition').on('change', applyFilters);
                valuePropositionSelect.on('change', renderVPScoreFilters);

                [topGlobalSearchInput, availabilityInput, experienceInput, joinDateAfterInput].forEach(el => el.addEventListener('input', applyFilters));
                
                resetBtn.addEventListener('click', () => {
                    topGlobalSearchInput.value = '';
                    $('select').val(null).trigger('change');
                    availabilityInput.value = '';
                    joinDateAfterInput.value = '';
                    experienceInput.value = 0;
                    experienceValue.textContent = '0 years';
                    consultantsToCompare = [];
                    
                    sidebarEmploymentStatusSelect.val('Active - Stable').trigger('change');
                });
                
                experienceInput.addEventListener('input', e => experienceValue.textContent = `${e.target.value} year${e.target.value != 1 ? 's' : ''}`);
                
                consultantList.addEventListener('click', e => {
                    if (e.target.classList.contains('download-pdf-btn')) {
                        const id = e.target.dataset.id;
                        const consultant = allConsultants.find(c => c.dmeId === id);
                        if (consultant) {
                            generatePDF(consultant);
                        }
                    }
                });
                
                consultantList.addEventListener('change', e => {
                    if (e.target.classList.contains('compare-checkbox')) {
                        const id = e.target.dataset.id;
                        if (e.target.checked) {
                            if (!consultantsToCompare.includes(id)) {
                                consultantsToCompare.push(id);
                            }
                        } else {
                            consultantsToCompare = consultantsToCompare.filter(consultantId => consultantId !== id);
                        }
                        updateCompareUI();
                    }
                });

                consultantList.addEventListener('click', e => {
                    const compareBox = e.target.closest('.compare-box');
                    if (compareBox && e.target.type !== 'checkbox') {
                        e.preventDefault();
                        const checkbox = compareBox.querySelector('.compare-checkbox');
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            const changeEvent = new Event('change', { bubbles: true });
                            checkbox.dispatchEvent(changeEvent);
                        }
                    }
                });

                viewControls.addEventListener('click', e => {
                    if (e.target.id === 'show-list-view') switchView('list');
                    if (e.target.id === 'show-compare-view') switchView('compare');
                    if (e.target.id === 'show-insights-view') switchView('insights');
                    if (e.target.id === 'show-timeline-view') switchView('timeline');
                    if (e.target.id === 'show-recommender-view') switchView('recommender');
                    if (e.target.id === 'compare-now-btn') switchView('compare');
                    if (e.target.id === 'clear-comparison-btn') {
                        consultantsToCompare = [];
                        document.querySelectorAll('.compare-checkbox:checked').forEach(cb => cb.checked = false);
                        updateCompareUI();
                    }
                });

                compareView.addEventListener('click', e => {
                    const removeBtn = e.target.closest('.remove-consultant-btn');
                    if (removeBtn) {
                        const idToRemove = removeBtn.dataset.id;
                        consultantsToCompare = consultantsToCompare.filter(id => id !== idToRemove);
                        
                        const mainCheckbox = document.getElementById(`compare-${idToRemove}`);
                        if (mainCheckbox) mainCheckbox.checked = false;
                        
                        updateCompareUI();

                        if (consultantsToCompare.length < 2) {
                            renderCompareView();
                        } else {
                            renderComparisonTable();
                        }
                        return;
                    }

                    const showMoreBtn = e.target.closest('.show-more-compare-caps');
                    if (showMoreBtn) {
                        const targetId = showMoreBtn.dataset.target;
                        const hiddenContainer = document.getElementById(targetId);
                        if (hiddenContainer) {
                            const isHidden = hiddenContainer.style.display === 'none';
                            hiddenContainer.style.display = isHidden ? 'inline' : 'none';
                            showMoreBtn.textContent = isHidden ? 'Show less' : `Show ${showMoreBtn.dataset.count} more...`;
                        }
                    }
                });
            }

            function applyFilters() {
                const searchTerms = topGlobalSearchInput.value.toLowerCase().split(',').map(s => s.trim()).filter(Boolean);
                
                const practices = topPracticeSelect.val();
                const offices = topOfficeSelect.val();
                const employmentStatuses = sidebarEmploymentStatusSelect.val();

                const managers = managerSelect.val();
                const grades = gradeSelect.val();
                const profileCaps = profileCapabilitiesSelect.val();
                const clients = clientSelect.val(), projects = projectSelect.val();
                const availDate = availabilityInput.value ? new Date(availabilityInput.value) : null;
                const minExp = parseInt(experienceInput.value);
                const joinDate = joinDateAfterInput.value ? new Date(joinDateAfterInput.value) : null;

                const vpRequirements = [];
                document.querySelectorAll('.vp-score-input').forEach(input => {
                    vpRequirements.push({
                        name: input.dataset.vpName,
                        score: parseInt(input.value, 10) || 0
                    });
                });

                filteredConsultants = allConsultants.filter(c => {
                    if (c.totalYrsOfExp < minExp) return false;
                    if (availDate) {
                        const cAvail = c.availabilityStartDate?.toLowerCase();
                        if (!cAvail || (cAvail !== 'immediate' && (parseDate(c.availabilityStartDate) > availDate))) return false;
                    }
                    const check = (arr, val) => !arr || !arr.length || arr.includes(val);
                    if (!check(managers, c.directManager) || !check(grades, c.grade) || !check(practices, c.practice)) return false;
                    if (!check(offices, c.office)) return false;
                    if (!check(employmentStatuses, c.employmentStage)) return false;

                    if (joinDate) {
                        const cJoinDate = parseDate(c.joinDate);
                        if (!cJoinDate || cJoinDate < joinDate) return false;
                    }

                    const consultantCaps = (c.profileCapabilities || '').toLowerCase();
                    if (profileCaps && profileCaps.length && !profileCaps.every(reqCap => consultantCaps.includes(reqCap.toLowerCase()))) return false;

                    if (vpRequirements.length > 0) {
                        const consultantVPs = (c.vpFit || '').split(';')
                            .map(item => {
                                const match = item.trim().match(/(.*?)\s*\((\d+)%\)/);
                                return match ? { name: match[1].trim(), score: parseInt(match[2], 10) } : null;
                            })
                            .filter(vp => vp);

                        const meetsAllVPReqs = vpRequirements.every(req => {
                            return consultantVPs.some(cvp =>
                                cvp.name === req.name && cvp.score >= req.score
                            );
                        });
                        if (!meetsAllVPReqs) return false;
                    }

                    const cProjects = allProjects.filter(p => p.consultantId === c.dmeId);
                    if ((clients && clients.length && !cProjects.some(p => clients.includes(p.client))) || (projects && projects.length && !cProjects.some(p => projects.includes(p.project)))) return false;

                    const searchable = [c.consultantName, c.grade, c.practice, c.resumeSummary, c.technicalSkills, c.functionalSkills, c.softSkills, c.projectHistoryStr].join(' ').toLowerCase();
                    return !searchTerms.length || searchTerms.every(term => searchable.includes(term));
                });
                renderConsultants(filteredConsultants);
                renderKPIs(filteredConsultants);
                updateCompareUI();
                
                if (!insightsView.classList.contains('hidden')) {
                    renderInsightsView(true);
                }
                if (!timelineView.classList.contains('hidden')) {
                    renderTimelineView(true);
                }
            }

            function switchView(view) {
                const showListViewBtn = document.getElementById('show-list-view');
                const showCompareViewBtn = document.getElementById('show-compare-view');
                const showInsightsViewBtn = document.getElementById('show-insights-view');
                const showTimelineViewBtn = document.getElementById('show-timeline-view');
                const showRecommenderViewBtn = document.getElementById('show-recommender-view');

                listView.classList.toggle('hidden', view !== 'list');
                compareView.classList.toggle('hidden', view !== 'compare');
                insightsView.classList.toggle('hidden', view !== 'insights');
                timelineView.classList.toggle('hidden', view !== 'timeline');
                recommenderView.classList.toggle('hidden', view !== 'recommender');

                showListViewBtn.disabled = view === 'list';
                showCompareViewBtn.disabled = view === 'compare';
                showInsightsViewBtn.disabled = view === 'insights';
                showTimelineViewBtn.disabled = view === 'timeline';
                showRecommenderViewBtn.disabled = view === 'recommender';
                
                if (view === 'compare') renderCompareView();
                if (view === 'insights') renderInsightsView(false);
                if (view === 'timeline') renderTimelineView(false);
                if (view === 'recommender') renderRecommenderView();
            }

            function updateCompareUI() {
                const compareActions = document.getElementById('compare-actions');
                const compareCountSpan = document.getElementById('compare-count');
                const compareNowBtn = document.getElementById('compare-now-btn');

                if (!compareActions || !compareCountSpan || !compareNowBtn) return;

                const count = consultantsToCompare.length;
                compareActions.classList.toggle('hidden', count === 0);
                compareCountSpan.textContent = `${count} selected`;
                compareNowBtn.disabled = count < 2;
            }
            
            function renderKPIs(data) {
                const count = data.length;
                const avgExp = count > 0 ? data.reduce((sum, c) => sum + c.totalYrsOfExp, 0) / count : 0;

                let immediateCount = 0;
                let nextThreeMonthsCount = 0;
                const today = new Date();
                today.setHours(0, 0, 0, 0); 
                const threeMonthsFromNow = new Date(today);
                threeMonthsFromNow.setMonth(today.getMonth() + 3);

                data.forEach(c => {
                    const availDateStr = c.availabilityStartDate;
                    if (!availDateStr) return;

                    if (availDateStr.toLowerCase() === 'immediate') {
                        immediateCount++;
                    } else {
                        const availDate = parseDate(availDateStr);
                        if (availDate && availDate >= today && availDate <= threeMonthsFromNow) {
                            nextThreeMonthsCount++;
                        }
                    }
                });

                kpiSection.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-md flex flex-col justify-between">
                        <p class="text-sm text-gray-500">Matching Consultants</p>
                        <p class="text-3xl font-bold text-indigo-600 text-right">${count}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md flex flex-col justify-between">
                        <p class="text-sm text-gray-500">Avg. Total Experience</p>
                        <p class="text-3xl font-bold text-indigo-600 text-right">${avgExp.toFixed(1)} yrs</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md h-full flex flex-col">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Upcoming Availability</h3>
                        <div class="flex justify-around items-center flex-grow">
                            <div class="text-center">
                                <p class="text-3xl font-bold text-green-600">${immediateCount}</p>
                                <p class="text-xs font-semibold text-gray-500">Immediate</p>
                            </div>
                            <div class="text-center">
                                <p class="text-3xl font-bold text-indigo-600">${nextThreeMonthsCount}</p>
                                <p class="text-xs font-semibold text-gray-500">Next 3 Months</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderCapabilities(capsString, consultantId) {
                if (!capsString || capsString.trim() === '') {
                    return '<span class="text-sm text-gray-500">N/A</span>';
                }

                const levelClassMap = {
                    'expert': 'bg-purple-100 text-purple-800',
                    'medium': 'bg-blue-100 text-blue-800',
                    'foundation': 'bg-gray-100 text-gray-800'
                };

                const capabilities = capsString.split(';').map(s => {
                    const match = s.trim().match(/(.+?)\s*\((expert|medium|foundation)\)/i);
                    if (match) {
                        return { name: match[1].trim(), level: match[2].toLowerCase() };
                    }
                    return { name: s.trim(), level: 'foundation' };
                }).filter(c => c.name);

                const groupedCaps = { expert: [], medium: [], foundation: [] };
                capabilities.forEach(cap => {
                    if (groupedCaps[cap.level]) {
                        groupedCaps[cap.level].push(cap);
                    }
                });

                for (const level in groupedCaps) {
                    groupedCaps[level].sort((a, b) => a.name.localeCompare(b.name));
                }

                let html = '';
                for (const level of ['expert', 'medium', 'foundation']) {
                    const capsInLevel = groupedCaps[level];
                    if (capsInLevel.length > 0) {
                        const pillClasses = levelClassMap[level];
                        const pillsHtml = capsInLevel.map(cap => 
                            `<span class="inline-block ${pillClasses} text-xs font-semibold mr-2 mb-2 px-3 py-1 rounded-full">${cap.name}</span>`
                        ).join('');

                        html += `
                            <details class="py-2">
                                <summary class="font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 capitalize text-sm">
                                    ${level} (${capsInLevel.length})
                                </summary>
                                <div class="pt-2 flex flex-wrap">
                                    ${pillsHtml}
                                </div>
                            </details>
                        `;
                    }
                }
                
                return html || '<span class="text-sm text-gray-500">N/A</span>';
            }

            function renderPresales(oppsString) {
                const opportunities = parseOpportunities(oppsString);
                if (opportunities.length === 0) {
                    return `<p class="text-gray-500 text-sm">No presales engagements.</p>`;
                }

                const getStatusColor = (status) => {
                    const s = status.toLowerCase();
                    if (s.includes('won')) return { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300' };
                    if (s.includes('cancel') || s.includes('lost')) return { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300' };
                    return { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-300' };
                };

                const presalesHtml = opportunities.map(opp => {
                    const color = getStatusColor(opp.status);
                    const clientDisplay = opp.classification ? `${opp.client} (${opp.classification})` : opp.client;

                    return `
                        <li class="border-l-4 ${color.border} pl-3">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-gray-800 text-sm">${opp.name}</p>
                                    <p class="text-xs text-gray-500">${clientDisplay}</p>
                                </div>
                                <span class="text-xs font-medium px-2 py-1 rounded-full ${color.bg} ${color.text} flex-shrink-0 ml-2">${opp.status}</span>
                            </div>
                        </li>`;
                }).join('');

                return `<ul class="space-y-4">${presalesHtml}</ul>`;
            }

            function renderVPHeatmapFromString(vpFitString) {
                if (!vpFitString || vpFitString.trim() === '') {
                    return '<p class="text-gray-500 text-sm">No VP Fit data available.</p>';
                }

                const heatmapItems = vpFitString.split(';')
                    .map(item => {
                        const match = item.trim().match(/(.*?)\s*\((\d+)%\)/);
                        if (match) {
                            return { name: match[1].trim(), score: parseInt(match[2], 10) };
                        }
                        return null;
                    })
                    .filter(item => item !== null)
                    .sort((a, b) => b.score - a.score);

                if (heatmapItems.length === 0) {
                    return '<p class="text-gray-500">No relevant Value Proposition matches found.</p>';
                }

                return `<ul class="space-y-3">${heatmapItems.map(item => {
                    let bgColor = 'bg-red-500';
                    if (item.score > 75) bgColor = 'bg-green-500';
                    else if (item.score > 40) bgColor = 'bg-yellow-500';

                    return `
                        <li>
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-semibold text-gray-700 text-sm">${item.name}</span>
                                <span class="font-bold text-sm">${item.score}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="${bgColor} h-2.5 rounded-full" style="width: ${item.score}%"></div>
                            </div>
                        </li>
                    `;
                }).join('')}</ul>`;
            }

            function getEmploymentStatusStyle(stage) {
                const stageLower = (stage || '').toLowerCase();

                if (stageLower.startsWith('onboarding')) return 'text-blue-600';
                if (stageLower.startsWith('probation')) return 'text-orange-600';
                if (stageLower === 'active - stable') return 'font-bold text-green-600';
                if (stageLower === 'active - resignation') return 'text-red-600';
                if (stageLower.startsWith('exit')) return 'text-red-600';
                if (stageLower.startsWith('alumni')) return 'text-gray-600';
                
                return 'text-gray-800';
            }

            function renderConsultants(consultants) {
                consultantList.innerHTML = '';
                noResults.classList.toggle('hidden', consultants.length > 0);
                consultants.forEach(c => {
                    const card = document.createElement('div');
                    card.id = `consultant-card-${c.dmeId}`;
                    card.className = 'consultant-card rounded-xl shadow-lg';
                    
                    const imageSrc = getDirectImageLink(c.imageLink);
                    const safePlaceholderSVG = placeholderSVG.replace(/"/g, '&quot;');
                    
                    const highQualitySrc = getHighQualityImageLink(c.imageLink);
                    const imageHtml = `<img src="${imageSrc}" alt="${c.consultantName}" class="w-full h-full object-cover" style="object-position: top;" onerror="this.parentElement.innerHTML = '${safePlaceholderSVG.replace('w-10 h-10', 'w-20 h-20')}';">`;
                    const imageWrapperHtml = `<div class="cursor-pointer image-click-target" data-hq-image-link="${highQualitySrc}">${imageHtml}</div>`;


                    const isAvailable = c.availabilityStartDate?.toLowerCase() === 'immediate';
                    const availabilityColor = isAvailable ? 'text-green-600' : 'text-amber-600';
                    
                    let practiceAndBu = c.practice || 'N/A';
                    if (c.businessUnit) practiceAndBu += ` (${c.businessUnit})`;
                    let titleHtml = c.grade ? `${c.grade}, ${practiceAndBu}` : practiceAndBu;

                    const consultantProjects = parseProjectHistory(c.projectHistoryStr);
                    
                    const tenureInMonths = parseTenureToMonths(c.tenure);
                    const fullTenureText = tenureInMonths > 0 ? `(${tenureInMonths} months)` : '';
                    
                    const employmentStatusText = c.employmentStage || 'N/A';
                    const employmentStatusClass = getEmploymentStatusStyle(c.employmentStage);
                    
                    const isCheckedForCompare = consultantsToCompare.includes(c.dmeId) ? 'checked' : '';

                    card.innerHTML = `
                        <div class="flex flex-col md:flex-row">
                            <div class="md:w-1/3 p-4 flex flex-col border-r border-slate-200">
                                <div class="flex items-center gap-4">
                                    <div class="w-20 h-20 bg-slate-200 rounded-full overflow-hidden shadow-md flex-shrink-0">${imageWrapperHtml}</div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900">${c.consultantName}</h3>
                                        <p class="text-sm font-medium text-indigo-600">${titleHtml}</p>
                                    </div>
                                </div>

                                <label for="compare-${c.dmeId}" class="compare-box w-full mt-4 flex items-center justify-center gap-2 text-sm font-semibold cursor-pointer text-slate-600 hover:text-indigo-600 p-2 rounded-lg bg-slate-100 hover:bg-indigo-50">
                                    <input type="checkbox" id="compare-${c.dmeId}" data-id="${c.dmeId}" class="compare-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isCheckedForCompare}>
                                    <span>Compare Profile</span>
                                </label>
                                
                                <div class="space-y-3 mt-4 text-sm">
                                    <div class="card-kpi-item">
                                        <div class="text-xs text-gray-500">Experience</div>
                                        <div class="font-bold text-gray-800">${c.totalYrsOfExp} yrs</div>
                                    </div>
                                    <div class="card-kpi-item">
                                        <div class="text-xs text-gray-500">Contractual Status</div>
                                        <div class="${employmentStatusClass}">${employmentStatusText}</div>
                                    </div>
                                    <div class="card-kpi-item">
                                        <div class="text-xs text-gray-500">Availability</div>
                                        <div class="font-bold ${availabilityColor}">${c.availabilityStartDate || 'N/A'}</div>
                                    </div>
                                </div>
                                
                                <div class="mt-auto pt-4 border-t border-slate-200 flex flex-col space-y-2 text-sm">
                                    <button data-id="${c.dmeId}" class="download-pdf-btn text-indigo-600 hover:underline font-semibold text-left">Download PDF Profile &darr;</button>
                                    <a href="${c.resumeLink}" target="_blank" class="text-indigo-600 hover:underline font-semibold ${!c.resumeLink ? 'hidden' : ''}">View Full Resume &rarr;</a>
                                    <a href="https://calendar.google.com/calendar/render?action=TEMPLATE&add=${encodeURIComponent(c.email)}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline font-semibold">Schedule Meeting &rarr;</a>
                                    <a href="https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(c.email)}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline font-semibold">Send Email &rarr;</a>
                                </div>
                            </div>

                            <div class="md:w-2/3 flex-grow p-4">
                                <p class="text-gray-600 leading-relaxed text-sm pb-4 border-b">${c.resumeSummary || 'No summary available.'}</p>
                                
                                <div class="mt-2 space-y-1">
                                    <details class="story-section">
                                        <summary>Capabilities & Skills</summary>
                                        <div class="content text-sm">${renderCapabilities(c.profileCapabilities, c.dmeId)}</div>
                                    </details>

                                    <details class="story-section border-t">
                                        <summary>Value Proposition Fit</summary>
                                        <div class="content">${renderVPHeatmapFromString(c.vpFit)}</div>
                                    </details>

                                    <details class="story-section border-t">
                                        <summary>Engagement History</summary>
                                        <div class="content space-y-6">
                                            <div>
                                                <h4 class="text-md font-semibold text-gray-700 mb-3">Project History</h4>
                                                ${consultantProjects.length > 0 ? `<ul class="space-y-5">${consultantProjects.map(p => {
                                                    let statusColorClass = 'bg-gray-100 text-gray-800';
                                                    if (p.status.toLowerCase().includes('in progress')) { statusColorClass = 'bg-blue-100 text-blue-800'; }
                                                    else if (p.status.toLowerCase().includes('completed')) { statusColorClass = 'bg-green-100 text-green-800'; }
                                                    return `<li class="project-entry"><div class="flex justify-between items-start"><div><p class="font-bold text-gray-800 text-sm">${p.project} <span class="text-xs font-medium text-gray-500">at ${p.client}</span></p><p class="text-xs text-gray-500">${p.role} &bull; ${p.period} &bull; <span class="font-semibold">${p.utilization}</span></p></div><span class="text-xs font-medium px-2 py-1 rounded-full ${statusColorClass} flex-shrink-0 ml-2">${p.status}</span></div></li>`
                                                }).join('')}</ul>` : `<p class="text-gray-500 text-sm">No project history.</p>`}
                                            </div>
                                            <div>
                                                <h4 class="text-md font-semibold text-gray-700 mb-3">Presales History</h4>
                                                ${renderPresales(c.engagedOpportunities)}
                                            </div>
                                        </div>
                                    </details>

                                     <details class="story-section border-t">
                                         <summary>Details</summary>
                                         <div class="content grid grid-cols-2 gap-4 text-sm">
                                             <div><strong class="block text-gray-500">Direct Manager:</strong> ${c.directManager || 'N/A'}</div>
                                             <div><strong class="block text-gray-500">Career Advisor:</strong> ${c.careerAdvisor || 'N/A'}</div>
                                             <div><strong class="block text-gray-500">Office:</strong> ${c.office || 'N/A'}</div>
                                             <div><strong class="block text-gray-500">Join Date:</strong> ${c.joinDate || 'N/A'} ${fullTenureText}</div>
                                         </div>
                                     </details>
                                </div>
                            </div>
                        </div>
                    `;
                    consultantList.appendChild(card);
                });
            }

            function setupImageModal() {
                const modal = document.getElementById('image-modal');
                const modalImage = document.getElementById('modal-image');
                const closeButton = document.getElementById('modal-close-btn');

                document.addEventListener('click', (e) => {
                    const imageWrapper = e.target.closest('.image-click-target');
                    if (imageWrapper) {
                        const highQualitySrc = imageWrapper.dataset.hqImageLink;
                        if (highQualitySrc) {
                            modalImage.src = highQualitySrc;
                            modal.classList.remove('hidden');
                            modal.classList.add('flex');
                        }
                    }
                });

                closeButton.addEventListener('click', () => {
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                });
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('flex');
                        modal.classList.add('hidden');
                    }
                });
            }

            function generatePDF(consultant) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text(consultant.consultantName || 'N/A', 15, 20);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const title = `${consultant.grade || ''}, ${consultant.practice || ''}`;
                doc.text(title, 15, 28);
                doc.line(15, 32, 195, 32);

                let finalY = 40;

                if (consultant.resumeSummary) {
                    doc.autoTable({
                        startY: finalY,
                        head: [['Summary']],
                        body: [[consultant.resumeSummary]],
                        theme: 'grid',
                        headStyles: { fillColor: [79, 70, 229] }
                    });
                    finalY = doc.autoTable.previous.finalY + 10;
                }

                const keyInfo = [
                    ['Total Experience', `${consultant.totalYrsOfExp || '0'} yrs`],
                    ['Availability', consultant.availabilityStartDate || 'N/A'],
                    ['Employment Status', consultant.employmentStage || 'N/A'],
                    ['Office', consultant.office || 'N/A'],
                    ['Direct Manager', consultant.directManager || 'N/A'],
                    ['Career Advisor', consultant.careerAdvisor || 'N/A']
                ];
                doc.autoTable({
                    startY: finalY,
                    head: [['Attribute', 'Details']],
                    body: keyInfo,
                    headStyles: { fillColor: [79, 70, 229] }
                });
                finalY = doc.autoTable.previous.finalY + 10;

                if (consultant.profileCapabilities) {
                    const capabilities = consultant.profileCapabilities.split(';').map(s => {
                        const match = s.trim().match(/(.+?)\s*\((expert|medium|foundation)\)/i);
                        return match ? { name: match[1].trim(), level: match[2].toLowerCase() } : { name: s.trim(), level: 'foundation' };
                    }).filter(c => c.name);

                    const grouped = { expert: [], medium: [], foundation: [] };
                    capabilities.forEach(c => grouped[c.level] && grouped[c.level].push(c.name));
                    
                    const capabilitiesBody = [
                        ['Expert', grouped.expert.join(', ')],
                        ['Medium', grouped.medium.join(', ')],
                        ['Foundation', grouped.foundation.join(', ')]
                    ].filter(row => row[1]);

                    if (capabilitiesBody.length > 0) {
                        doc.autoTable({
                            startY: finalY,
                            head: [['Proficiency', 'Skills']],
                            body: capabilitiesBody,
                            headStyles: { fillColor: [79, 70, 229] }
                        });
                        finalY = doc.autoTable.previous.finalY + 10;
                    }
                }
                
                const projects = parseProjectHistory(consultant.projectHistoryStr);
                if (projects.length > 0) {
                     const projectBody = projects.map(p => [
                        p.project,
                        p.client,
                        p.role,
                        p.period,
                        p.utilization
                    ]);
                    doc.autoTable({
                        startY: finalY,
                        head: [['Project', 'Client', 'Role', 'Period', 'Utilization']],
                        body: projectBody,
                        headStyles: { fillColor: [79, 70, 229] }
                    });
                }

                doc.save(`Profile - ${consultant.consultantName}.pdf`);
            }

            function renderVacationTimeline(container, vacationStr, currentYear) {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const vacations = parseVacations(vacationStr).filter(v => v.end >= today && v.start.getFullYear() === currentYear);
                if (vacations.length === 0) return;
                
                const dateFormatOptions = { day: 'numeric', month: 'short' };
                container.innerHTML = `<ul class="space-y-2 text-xs">${vacations.map(v => {
                    const status = (today >= v.start && today <= v.end) ? 'Ongoing' : 'Planned';
                    const statusColor = status === 'Ongoing' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                    return `<li class="flex items-center justify-between gap-x-3 p-1.5 rounded-md bg-slate-100">
                        <span class="font-medium text-gray-600">${v.start.toLocaleDateString('en-GB', dateFormatOptions)} - ${v.end.toLocaleDateString('en-GB', dateFormatOptions)}</span>
                        <span class="font-bold py-0.5 px-2 rounded-full ${statusColor}">${status}</span></li>`;
                }).join('')}</ul>`;
            }

            /* --- COMPARE VIEW FUNCTIONS --- */

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.feature-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            function renderFeatureControls() {
                const container = document.getElementById('feature-list-container');
                if (!container) return;
                container.innerHTML = ''; 

                ALL_FEATURES.forEach(feature => {
                    const isChecked = selectedCompareFeatures.includes(feature.key);
                    const featureEl = document.createElement('div');
                    featureEl.className = 'feature-item bg-white p-2 rounded-md shadow-sm flex items-center gap-3 cursor-grab';
                    featureEl.setAttribute('draggable', true);
                    featureEl.dataset.featureKey = feature.key;
                    
                    featureEl.innerHTML = `
                        <input type="checkbox" id="feature-checkbox-${feature.key}" data-key="${feature.key}" class="feature-toggle-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isChecked ? 'checked' : ''}>
                        <label for="feature-checkbox-${feature.key}" class="text-sm font-medium text-gray-800 flex-grow cursor-pointer">${feature.label}</label>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                    `;
                    container.appendChild(featureEl);
                });

                container.querySelectorAll('.feature-toggle-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const key = e.target.dataset.key;
                        if (e.target.checked) {
                            if (!selectedCompareFeatures.includes(key)) selectedCompareFeatures.push(key);
                        } else {
                            selectedCompareFeatures = selectedCompareFeatures.filter(fKey => fKey !== key);
                        }
                        renderComparisonTable();
                    });
                });

                let draggedItem = null;
                container.addEventListener('dragstart', (e) => {
                    draggedItem = e.target.closest('.feature-item');
                    if(draggedItem) {
                        setTimeout(() => draggedItem.classList.add('dragging'), 0);
                    }
                });

                container.addEventListener('dragend', (e) => {
                    if(draggedItem) {
                        draggedItem.classList.remove('dragging');
                        draggedItem = null;
                    }
                });

                container.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(container, e.clientY);
                    if (draggedItem) {
                        if (afterElement == null) {
                            container.appendChild(draggedItem);
                        } else {
                            container.insertBefore(draggedItem, afterElement);
                        }
                    }
                });

                container.addEventListener('drop', e => {
                    e.preventDefault();
                    const newOrderKeys = [...container.querySelectorAll('.feature-item')].map(item => item.dataset.featureKey);
                    selectedCompareFeatures = newOrderKeys.filter(key => selectedCompareFeatures.includes(key));
                    renderComparisonTable();
                });
            }

            function renderComparePills(capsString, targetLevel, consultantId) {
                if (!capsString) return 'N/A';
                
                const levelClassMap = {
                    'expert': 'bg-purple-100 text-purple-800',
                    'medium': 'bg-blue-100 text-blue-800',
                    'foundation': 'bg-gray-100 text-gray-800'
                };
                const pillClasses = levelClassMap[targetLevel] || levelClassMap['foundation'];

                const allCaps = capsString.split(';')
                    .map(s => {
                        const match = s.trim().match(/(.+?)\s*\((expert|medium|foundation)\)/i);
                        const level = match ? match[2].toLowerCase() : 'foundation';
                        const name = match ? match[1].trim() : s.trim();
                        return { name, level };
                    })
                    .filter(c => c.name && c.level === targetLevel)
                    .sort((a,b) => a.name.localeCompare(b.name));

                if (allCaps.length === 0) return 'N/A';

                const generatePillHtml = (cap) => `<span class="inline-block ${pillClasses} text-xs font-semibold mr-1 mb-1 px-2 py-1 rounded-full">${cap.name}</span>`;
                
                const limit = 5;
                if (allCaps.length > limit) {
                    const visibleHtml = allCaps.slice(0, limit).map(generatePillHtml).join('');
                    const hiddenHtml = allCaps.slice(limit).map(generatePillHtml).join('');
                    const hiddenContainerId = `hidden-caps-${consultantId}-${targetLevel}`;
                    
                    return `
                        <div class="flex flex-wrap items-center" style="white-space: normal;">
                            ${visibleHtml}
                            <div id="${hiddenContainerId}" class="inline" style="display: none;">${hiddenHtml}</div>
                            <button class="show-more-compare-caps text-indigo-600 hover:underline text-xs font-semibold ml-1" 
                                    data-target="${hiddenContainerId}" 
                                    data-count="${allCaps.length - limit}">
                                Show ${allCaps.length - limit} more...
                            </button>
                        </div>
                    `;
                } else {
                    return `<div class="flex flex-wrap" style="white-space: normal;">${allCaps.map(generatePillHtml).join('')}</div>`;
                }
            }

            function renderCompareHeatmap(vpFitString) {
                if (!vpFitString) return 'N/A';
                const heatmapItems = vpFitString.split(';')
                    .map(item => {
                        const match = item.trim().match(/(.*?)\s*\((\d+)%\)/);
                        if (match) {
                            return { name: match[1].trim(), score: parseInt(match[2], 10) };
                        }
                        return null;
                    })
                    .filter(item => item !== null)
                    .sort((a, b) => b.score - a.score);

                if (heatmapItems.length === 0) {
                    return '<p class="text-gray-500">No relevant Value Proposition matches found.</p>';
                }

                return `<ul class="text-xs space-y-1" style="white-space: normal;">${heatmapItems.map(item => `<li><strong>${item.score}%</strong> - ${item.name}</li>`).join('')}</ul>`;
            }


            function renderComparisonTable() {
                const container = document.getElementById('compare-table-container');
                if(!container) return;

                const selectedConsultants = consultantsToCompare.map(id => allConsultants.find(c => c.dmeId === id));
                let headHtml = '', bodyRows = '';

                selectedConsultants.forEach(c => {
                    const safePlaceholderSVG = placeholderSVG.replace(/"/g, '&quot;');
                    const imageSrc = getDirectImageLink(c.imageLink);
                    const imageHtml = `<img src="${imageSrc}" alt="${c.consultantName}" class="w-16 h-16 mx-auto object-cover rounded-full shadow-md" style="object-position: top;" onerror="this.parentElement.innerHTML = '${safePlaceholderSVG.replace('w-10 h-10', 'w-16 h-16')}';">`;
                    headHtml += `
                        <th class="consultant-col">
                            <div class="relative text-center p-2">
                                <button data-id="${c.dmeId}" class="remove-consultant-btn absolute top-0 right-0 text-gray-400 hover:text-red-600 text-2xl font-bold leading-none p-1" title="Remove from comparison">&times;</button>
                                ${imageHtml}
                                <h3 class="font-bold text-lg mt-3 text-gray-800">${c.consultantName}</h3>
                                <p class="text-sm font-medium text-indigo-600">${c.grade || 'N/A'}</p>
                            </div>
                        </th>`;
                });

                selectedCompareFeatures.forEach(featureKey => {
                    const feature = ALL_FEATURES.find(f => f.key === featureKey);
                    if (!feature) return;

                    let rowHtml = `<td><strong>${feature.label}</strong></td>`;
                    selectedConsultants.forEach(c => {
                        let displayValue = 'N/A';
                        switch (feature.type) {
                            case 'link':
                                const value = c[feature.key];
                                displayValue = value ? `<a href="${value}" target="_blank" class="text-indigo-600 hover:underline font-semibold">View Resume &rarr;</a>` : 'N/A';
                                break;
                            case 'percent':
                                displayValue = `${parseFloat(c[feature.key] || 0).toFixed(0)}%`;
                                break;
                            case 'pills':
                                displayValue = renderComparePills(c.profileCapabilities, feature.level, c.dmeId);
                                break;
                            case 'heatmap':
                                displayValue = renderCompareHeatmap(c.vpFit);
                                break;
                            default: // 'text'
                                displayValue = `${c[feature.key] || 'N/A'}${feature.suffix || ''}`;
                        }
                        rowHtml += `<td>${displayValue}</td>`;
                    });
                    bodyRows += `<tr>${rowHtml}</tr>`;
                });
                
                const tableIsEmpty = selectedCompareFeatures.length === 0;
                container.innerHTML = tableIsEmpty ? 
                    '<p class="text-center text-gray-500 p-8">Check a feature above to begin comparing.</p>' :
                    `<table class="w-full text-sm compare-table"><thead><tr><th class="w-1/5">Feature</th>${headHtml}</tr></thead><tbody>${bodyRows}</tbody></table>`;
            }

            function renderCompareView() {
                if (consultantsToCompare.length < 2) {
                    compareView.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-center text-gray-500 p-8">Select at least 2 consultants from the list view to start a comparison.</p></div>`;
                    return;
                }
                
                compareView.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Comparing ${consultantsToCompare.length} Consultants</h2>
                        <div class="flex flex-col md:flex-row gap-6 lg:gap-8">
                            <aside class="md:w-1/3 lg:w-1/4">
                                <div id="compare-feature-controls" class="sticky top-48 bg-slate-50 border border-slate-200 p-4 rounded-lg">
                                    <h3 class="font-bold text-lg mb-2">Customize Comparison</h3>
                                    <p class="text-sm text-gray-600 mb-4">Check features to add them to the table. Drag and drop to reorder.</p>
                                    <div id="feature-list-container" class="space-y-2"></div>
                                </div>
                            </aside>
                            <main id="compare-table-container" class="flex-grow overflow-x-auto"></main>
                        </div>
                    </div>
                `;
                
                renderFeatureControls();
                renderComparisonTable();
            }

            /* --- INSIGHTS VIEW FUNCTIONS --- */
            
            function parseTenureToMonths(tenureValue) {
                if (!tenureValue) return 0;
                const tenureStr = String(tenureValue);
                let totalMonths = 0;
                const yearMatch = tenureStr.match(/(\d+)\s*year/);
                const monthMatch = tenureStr.match(/(\d+)\s*month/);
                if (yearMatch) totalMonths += parseInt(yearMatch[1], 10) * 12;
                if (monthMatch) totalMonths += parseInt(monthMatch[1], 10);
                return totalMonths > 0 ? totalMonths : parseFloat(tenureStr) || 0;
            }

            function renderInsightsView(isUpdate = false) {
                 if (!isUpdate) {
                      insightsView.innerHTML = `
                             <div class="bg-white p-6 rounded-lg shadow-md">
                                 <h1 class="text-3xl font-bold mb-2 text-gray-800">Workforce Insights</h1>
                                 <p class="text-md text-gray-600 mb-8">An interactive story of our talent pool based on your current filters.</p>
                                
                                 <details class="story-section" open>
                                     <summary>The Story of Our Team: Service Time & Demographics</summary>
                                     <div class="content">
                                         <div id="tenure-insights" class="space-y-12">
                                             <div id="avg-tenure-section">
                                                 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                                     <div>
                                                         <h2 class="text-xl font-bold text-gray-800">Average Service Time</h2>
                                                         <p class="text-sm text-gray-600">Helps identify where retention is strong vs. weak across different groups.</p>
                                                     </div>
                                                     <div class="flex items-center gap-4">
                                                         <div class="flex-1 min-w-[150px]">
                                                             <label for="tenure-group-by" class="text-sm font-medium">Group By:</label>
                                                             <select id="tenure-group-by" class="w-full mt-1 p-2 border-gray-300 rounded-md shadow-sm text-sm">
                                                                 <option value="practice">Practice</option>
                                                                 <option value="businessUnit">BU</option>
                                                                 <option value="grade">Seniority (Grade)</option>
                                                             </select>
                                                         </div>
                                                         <div class="flex-1">
                                                             <label class="text-sm font-medium">Chart Type:</label>
                                                             <div id="tenure-chart-type" class="isolate inline-flex rounded-md shadow-sm mt-1">
                                                                 <button data-type="bar" data-axis="y" class="chart-control-btn active relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold focus:z-10">Horizontal Bar</button>
                                                                 <button data-type="bar" data-axis="x" class="chart-control-btn relative -ml-px inline-flex items-center px-3 py-2 text-sm font-semibold focus:z-10">Vertical Bar</button>
                                                                 <button data-type="line" class="chart-control-btn relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold focus:z-10">Line</button>
                                                             </div>
                                                         </div>
                                                     </div>
                                                 </div>
                                                 <div class="chart-container relative h-[500px] w-full"><canvas id="tenure-chart"></canvas></div>
                                             </div>
                                             <div id="dist-tenure-section">
                                                 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                                     <div>
                                                         <h2 class="text-xl font-bold text-gray-800">Distribution of Service Time</h2>
                                                         <p class="text-sm text-gray-600">Shows the mix of new vs. experienced consultants in each group.</p>
                                                     </div>
                                                     <div class="flex items-center gap-4">
                                                         <div class="flex-1 min-w-[150px]">
                                                             <label for="tenure-dist-group-by" class="text-sm font-medium">Group By:</label>
                                                             <select id="tenure-dist-group-by" class="w-full mt-1 p-2 border-gray-300 rounded-md shadow-sm text-sm">
                                                                 <option value="practice">Practice</option>
                                                                 <option value="businessUnit">BU</option>
                                                                 <option value="grade">Seniority (Grade)</option>
                                                             </select>
                                                         </div>
                                                         <div class="flex-1">
                                                             <label class="text-sm font-medium">Chart Type:</label>
                                                             <div id="tenure-dist-chart-type" class="isolate inline-flex rounded-md shadow-sm mt-1">
                                                                 <button data-type="bar" data-axis="y" class="chart-control-btn active relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold focus:z-10">Stacked Horizontal</button>
                                                                 <button data-type="bar" data-axis="x" class="chart-control-btn relative -ml-px inline-flex items-center px-3 py-2 text-sm font-semibold focus:z-10">Stacked Vertical</button>
                                                                 <button data-type="pie" class="chart-control-btn relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold focus:z-10">Pie</button>
                                                             </div>
                                                         </div>
                                                     </div>
                                                 </div>
                                                 <div class="chart-container relative h-[500px] w-full"><canvas id="tenure-distribution-chart"></canvas></div>
                                             </div>
                                         </div>
                                     </div>
                                 </details>

                                 <details class="story-section">
                                     <summary>The Story of Our Growth: Hiring Trends Over Time</summary>
                                     <div class="content">
                                         <div id="hiring-insights" class="space-y-12">
                                             <div>
                                                 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                                     <div>
                                                         <h2 class="text-xl font-bold text-gray-800">Hiring Volume Over Time</h2>
                                                         <p class="text-sm text-gray-600">Tracks the number of new joiners over different time periods.</p>
                                                     </div>
                                                     <div class="flex items-center gap-x-4">
                                                         <div>
                                                             <label class="text-sm font-medium">Aggregate By:</label>
                                                             <div id="hiring-volume-period" class="isolate inline-flex rounded-md shadow-sm mt-1">
                                                                 <button data-period="week" class="chart-control-btn relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold focus:z-10">Week</button>
                                                                 <button data-period="month" class="chart-control-btn active relative -ml-px inline-flex items-center px-3 py-2 text-sm font-semibold focus:z-10">Month</button>
                                                                 <button data-period="quarter" class="chart-control-btn relative -ml-px inline-flex items-center px-3 py-2 text-sm font-semibold focus:z-10">Quarter</button>
                                                                 <button data-period="year" class="chart-control-btn relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold focus:z-10">Year</button>
                                                             </div>
                                                         </div>
                                                          <div>
                                                             <label class="text-sm font-medium">Chart Type:</label>
                                                             <div id="hiring-volume-chart-type" class="isolate inline-flex rounded-md shadow-sm mt-1">
                                                                 <button data-type="bar" class="chart-control-btn active relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold focus:z-10">Bar</button>
                                                                 <button data-type="line" class="chart-control-btn relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold focus:z-10">Line</button>
                                                             </div>
                                                         </div>
                                                     </div>
                                                 </div>
                                                 <div class="chart-container relative h-[500px] w-full"><canvas id="hiring-volume-chart"></canvas></div>
                                             </div>
                                             <div>
                                                 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                                     <div>
                                                         <h2 class="text-xl font-bold text-gray-800">Seasonality of Hiring</h2>
                                                         <p id="hiring-seasonality-subtitle" class="text-sm text-gray-600">Identifies peak hiring months across all years in the dataset.</p>
                                                     </div>
                                                     <div>
                                                         <label class="text-sm font-medium">Chart Type:</label>
                                                         <div id="hiring-seasonality-chart-type" class="isolate inline-flex rounded-md shadow-sm mt-1">
                                                             <button data-type="line" class="chart-control-btn active relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold focus:z-10">Line</button>
                                                             <button data-type="bar" class="chart-control-btn relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold focus:z-10">Bar</button>
                                                         </div>
                                                     </div>
                                                 </div>
                                                 <div class="chart-container relative h-[500px] w-full"><canvas id="hiring-seasonality-chart"></canvas></div>
                                             </div>
                                             <div>
                                                 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                                     <div>
                                                         <h2 class="text-xl font-bold text-gray-800">Workforce Buildup by Practice</h2>
                                                         <p class="text-sm text-gray-600">Visualizes the cumulative headcount growth for each practice over time.</p>
                                                     </div>
                                                     <div>
                                                         <label class="text-sm font-medium">Chart Type:</label>
                                                         <div id="practice-growth-chart-type" class="isolate inline-flex rounded-md shadow-sm mt-1">
                                                             <button data-type="area" class="chart-control-btn active relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold focus:z-10">Stacked Area</button>
                                                             <button data-type="line" class="chart-control-btn relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold focus:z-10">Grouped Line</button>
                                                         </div>
                                                     </div>
                                                 </div>
                                                 <div class="chart-container relative h-[500px] w-full"><canvas id="practice-growth-chart"></canvas></div>
                                             </div>
                                         </div>
                                     </div>
                                 </details>

                                 <details class="story-section">
                                     <summary>The Story of Our Experience: A Look at Workforce Diversity</summary>
                                     <div class="content">
                                         <div id="diversity-insights" class="space-y-12">
                                             <div>
                                                 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                                     <div>
                                                         <h2 class="text-xl font-bold text-gray-800">Mix of New vs. Senior Joiners</h2>
                                                         <p class="text-sm text-gray-600">Balance of experience levels in the current selection.</p>
                                                     </div>
                                                     <div>
                                                         <label class="text-sm font-medium">Chart Type:</label>
                                                         <div id="joiner-mix-chart-type" class="isolate inline-flex rounded-md shadow-sm mt-1">
                                                             <button data-type="doughnut" class="chart-control-btn active relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold focus:z-10">Doughnut</button>
                                                             <button data-type="pie" class="chart-control-btn relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold focus:z-10">Pie</button>
                                                         </div>
                                                     </div>
                                                 </div>
                                                 <div class="chart-container relative h-[400px] w-full max-w-lg mx-auto"><canvas id="joiner-mix-chart"></canvas></div>
                                             </div>
                                             <div>
                                                 <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                                     <div>
                                                         <h2 class="text-xl font-bold text-gray-800">Practice Hiring Analysis</h2>
                                                         <p class="text-sm text-gray-600">Hiring concentration by practice and year.</p>
                                                     </div>
                                                     <div>
                                                         <label class="text-sm font-medium">Chart Type:</label>
                                                         <div id="practice-heatmap-chart-type" class="isolate inline-flex rounded-md shadow-sm mt-1">
                                                             <button data-type="matrix" class="chart-control-btn active relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold focus:z-10">Heatmap</button>
                                                             <button data-type="bubble" class="chart-control-btn relative -ml-px inline-flex items-center px-3 py-2 text-sm font-semibold focus:z-10">Bubble</button>
                                                             <button data-type="bar" class="chart-control-btn relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold focus:z-10">Stacked Bar</button>
                                                         </div>
                                                     </div>
                                                 </div>
                                                 <div class="chart-container relative h-[600px] w-full"><canvas id="practice-heatmap-chart"></canvas></div>
                                             </div>
                                         </div>
                                     </div>
                                 </details>
                             </div>
                         `;

                     const setupChartControls = (containerId, callback) => {
                         document.querySelectorAll(`#${containerId} button`).forEach(btn => btn.addEventListener('click', () => {
                             document.querySelectorAll(`#${containerId} button`).forEach(b => b.classList.remove('active'));
                             btn.classList.add('active');
                             callback();
                         }));
                     };
                     
                     document.getElementById('tenure-group-by').addEventListener('change', renderTenureCharts);
                     setupChartControls('tenure-chart-type', renderTenureCharts);
                     document.getElementById('tenure-dist-group-by').addEventListener('change', renderTenureCharts);
                     setupChartControls('tenure-dist-chart-type', renderTenureCharts);
                     
                     setupChartControls('hiring-volume-period', renderHiringCharts);
                     setupChartControls('hiring-volume-chart-type', renderHiringCharts);
                     setupChartControls('hiring-seasonality-chart-type', renderHiringCharts);
                     setupChartControls('practice-growth-chart-type', renderHiringCharts);

                     setupChartControls('joiner-mix-chart-type', renderDiversityCharts);
                     setupChartControls('practice-heatmap-chart-type', renderDiversityCharts);
                 }

                renderTenureCharts();
                renderHiringCharts();
                renderDiversityCharts();
            }

            function renderTenureCharts() {
                const groupBy = document.getElementById('tenure-group-by').value;
                const activeTypeBtn = document.querySelector('#tenure-chart-type button.active');
                const chartType = activeTypeBtn.dataset.type;
                const indexAxis = activeTypeBtn.dataset.axis || 'x';

                const groupData = {};
                filteredConsultants.forEach(c => {
                    const key = c[groupBy];
                    if (key) {
                        const tenureMonths = parseTenureToMonths(c.tenure);
                        if(tenureMonths > 0) {
                            if (!groupData[key]) groupData[key] = { total: 0, count: 0 };
                            groupData[key].total += tenureMonths;
                            groupData[key].count++;
                        }
                    }
                });

                let processedData = Object.keys(groupData).map(key => ({
                    label: `${key} (${groupData[key].count})`,
                    value: groupData[key].total / groupData[key].count,
                }));
                
                processedData.sort((a, b) => b.value - a.value);

                const labels = processedData.map(d => d.label);
                const avgData = processedData.map(d => d.value);

                const ctx = document.getElementById('tenure-chart').getContext('2d');
                if (tenureChartInstance) tenureChartInstance.destroy();
                tenureChartInstance = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Average Service Time (Months)',
                            data: avgData,
                            backgroundColor: 'rgba(79, 70, 229, 0.6)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: indexAxis,
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { x: { beginAtZero: true }, y: { beginAtZero: true } },
                        plugins: {
                            datalabels: {
                                anchor: 'end', align: 'end',
                                formatter: (value) => value.toFixed(1),
                                font: { weight: 'bold' }
                            },
                        }
                    },
                    plugins: [ChartDataLabels]
                });

                const distGroupBy = document.getElementById('tenure-dist-group-by').value;
                const activeDistTypeBtn = document.querySelector('#tenure-dist-chart-type button.active');
                const distChartType = activeDistTypeBtn.dataset.type;
                const distIndexAxis = activeDistTypeBtn.dataset.axis || 'x';
                const tenureBins = ['0-1 Years', '1-3 Years', '3-5 Years', '5+ Years'];
                
                const distGroupData = {};
                filteredConsultants.forEach(c => {
                    const key = c[distGroupBy];
                    if(key) {
                        if(!distGroupData[key]) distGroupData[key] = { '0-1 Years': 0, '1-3 Years': 0, '3-5 Years': 0, '5+ Years': 0, 'count': 0};
                        const tenureMonths = parseTenureToMonths(c.tenure);
                        if(tenureMonths > 0){
                            const years = tenureMonths / 12;
                            distGroupData[key].count++;
                            if (years <= 1) distGroupData[key]['0-1 Years']++;
                            else if (years <= 3) distGroupData[key]['1-3 Years']++;
                            else if (years <= 5) distGroupData[key]['3-5 Years']++;
                            else distGroupData[key]['5+ Years']++;
                        }
                    }
                });

                const distLabels = Object.keys(distGroupData).sort();
                const distDatasets = tenureBins.map((bin, i) => {
                    const colors = ['rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)'];
                    return {
                        label: bin,
                        data: distLabels.map(label => distGroupData[label][bin]),
                        backgroundColor: colors[i],
                    }
                });
                
                const distCtx = document.getElementById('tenure-distribution-chart').getContext('2d');
                if (tenureDistChartInstance) tenureDistChartInstance.destroy();
                tenureDistChartInstance = new Chart(distCtx, {
                    type: distChartType,
                    data: distChartType === 'pie' ? {
                        labels: tenureBins,
                        datasets: [{
                            data: tenureBins.map(bin => Object.values(distGroupData).reduce((sum, d) => sum + d[bin], 0)),
                            backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)'],
                        }]
                    } : {
                        labels: distLabels,
                        datasets: distDatasets
                    },
                    options: {
                        indexAxis: distIndexAxis,
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: distChartType === 'pie' ? {} : { x: { stacked: true }, y: { stacked: true } },
                        plugins: {
                             datalabels: {
                                color: '#fff',
                                formatter: (value) => value > 0 ? value : '',
                                font: { weight: 'bold' }
                            },
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            function renderHiringCharts() {
                const period = document.querySelector('#hiring-volume-period button.active').dataset.period;
                const volumeChartType = document.querySelector('#hiring-volume-chart-type button.active').dataset.type;
                const hiringVolume = {};
                const getPeriodKey = (date) => {
                    const year = date.getFullYear();
                    switch(period) {
                        case 'week':
                            const startOfYear = new Date(year, 0, 1);
                            const week = Math.ceil((((date - startOfYear) / 86400000) + startOfYear.getDay() + 1) / 7);
                            return `${year}-W${String(week).padStart(2, '0')}`;
                        case 'quarter':
                            const quarter = Math.floor(date.getMonth() / 3) + 1;
                            return `${year}-Q${quarter}`;
                        case 'year':
                            return String(year);
                        default: // month
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            return `${year}-${month}`;
                    }
                };

                filteredConsultants.forEach(c => {
                    const joinDate = parseDate(c.joinDate);
                    if (joinDate) {
                        const key = getPeriodKey(joinDate);
                        hiringVolume[key] = (hiringVolume[key] || 0) + 1;
                    }
                });
                const sortedVolume = Object.entries(hiringVolume).sort((a, b) => a[0].localeCompare(b[0]));
                
                const volumeCtx = document.getElementById('hiring-volume-chart').getContext('2d');
                if (hiringVolumeChartInstance) hiringVolumeChartInstance.destroy();
                hiringVolumeChartInstance = new Chart(volumeCtx, {
                    type: volumeChartType,
                    data: {
                        labels: sortedVolume.map(d => d[0]),
                        datasets: [{ 
                            label: 'Joiners', 
                            data: sortedVolume.map(d => d[1]), 
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { datalabels: { anchor: 'end', align: 'end', font: { weight: 'bold' } } }
                    },
                    plugins: [ChartDataLabels]
                });

                const seasonalityChartType = document.querySelector('#hiring-seasonality-chart-type button.active').dataset.type;
                const seasonality = Array(12).fill(0);
                const joinDates = filteredConsultants.map(c => parseDate(c.joinDate)).filter(Boolean);
                joinDates.forEach(date => seasonality[date.getMonth()]++);
                
                const minDate = joinDates.length ? new Date(Math.min(...joinDates)) : null;
                const maxDate = joinDates.length ? new Date(Math.max(...joinDates)) : null;
                const subtitleEl = document.getElementById('hiring-seasonality-subtitle');
                if (minDate && maxDate) {
                    subtitleEl.textContent = `Identifies peak hiring months. Data ranges from ${minDate.toLocaleDateString()} to ${maxDate.toLocaleDateString()}.`;
                }

                const seasonalityCtx = document.getElementById('hiring-seasonality-chart').getContext('2d');
                if (hiringSeasonalityChartInstance) hiringSeasonalityChartInstance.destroy();
                hiringSeasonalityChartInstance = new Chart(seasonalityCtx, {
                    type: seasonalityChartType,
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{ 
                            label: 'Hires per Month', 
                            data: seasonality, 
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)', 
                            fill: false, 
                            tension: 0.1 
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { datalabels: { backgroundColor: 'rgba(255, 99, 132, 0.8)', borderRadius: 4, color: 'white', font: { weight: 'bold' } } }
                    },
                    plugins: [ChartDataLabels]
                });

                const growthChartType = document.querySelector('#practice-growth-chart-type button.active').dataset.type;
                const isStacked = growthChartType === 'area';
                const practiceGrowth = {};
                const validConsultants = filteredConsultants.filter(c => c.joinDate && c.practice && parseDate(c.joinDate));
                let timelineLabels = [];

                if (validConsultants.length > 0) {
                    const allDates = validConsultants.map(c => parseDate(c.joinDate));
                    let overallMinDate = new Date(Math.min(...allDates));
                    let overallMaxDate = new Date();

                    let currentDate = new Date(overallMinDate.getFullYear(), overallMinDate.getMonth(), 1);
                    while (currentDate <= overallMaxDate) {
                        timelineLabels.push(`${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`);
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                    
                    const practices = [...new Set(validConsultants.map(c => c.practice))];
                    practices.forEach(p => {
                        const dataMap = {};
                        validConsultants.filter(c => c.practice === p).forEach(c => {
                             const joinDate = parseDate(c.joinDate);
                             const yearMonth = `${joinDate.getFullYear()}-${String(joinDate.getMonth() + 1).padStart(2, '0')}`;
                             dataMap[yearMonth] = (dataMap[yearMonth] || 0) + 1;
                        });

                        let cumulativeCount = 0;
                        const practiceData = [];
                        timelineLabels.forEach(label => {
                            cumulativeCount += (dataMap[label] || 0);
                            practiceData.push(cumulativeCount);
                        });
                        practiceGrowth[p] = practiceData;
                    });
                }
                
                const colors = ['rgba(54, 162, 235, 0.5)', 'rgba(255, 206, 86, 0.5)', 'rgba(75, 192, 192, 0.5)', 'rgba(153, 102, 255, 0.5)', 'rgba(255, 159, 64, 0.5)', 'rgba(255, 99, 132, 0.5)'];
                const growthDatasets = Object.keys(practiceGrowth).map((practice, i) => ({
                    label: practice,
                    data: practiceGrowth[practice],
                    borderColor: colors[i % colors.length].replace('0.5', '1'),
                    backgroundColor: colors[i % colors.length],
                    fill: isStacked,
                    tension: 0.1
                }));
                
                const growthCtx = document.getElementById('practice-growth-chart').getContext('2d');
                if (practiceGrowthChartInstance) practiceGrowthChartInstance.destroy();
                practiceGrowthChartInstance = new Chart(growthCtx, {
                    type: 'line',
                    data: { 
                        labels: timelineLabels,
                        datasets: growthDatasets 
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { 
                            x: { title: { display: true, text: 'Time' } }, 
                            y: { title: { display: true, text: 'Cumulative Hires' }, beginAtZero: true, stacked: isStacked } 
                        },
                        plugins: { datalabels: { display: false } }
                    }
                });
            }

            function renderDiversityCharts() {
                const joinerMixChartType = document.querySelector('#joiner-mix-chart-type button.active').dataset.type;
                const tenureBins = { '0-1 Years': 0, '1-3 Years': 0, '3-5 Years': 0, '5+ Years': 0 };
                 filteredConsultants.forEach(c => {
                    const tenureMonths = parseTenureToMonths(c.tenure);
                    if (tenureMonths > 0) {
                        const years = tenureMonths / 12;
                        if (years <= 1) tenureBins['0-1 Years']++;
                        else if (years <= 3) tenureBins['1-3 Years']++;
                        else if (years <= 5) tenureBins['3-5 Years']++;
                        else tenureBins['5+ Years']++;
                    }
                });

                const joinerMixCtx = document.getElementById('joiner-mix-chart').getContext('2d');
                if (joinerMixChartInstance) joinerMixChartInstance.destroy();
                joinerMixChartInstance = new Chart(joinerMixCtx, {
                    type: joinerMixChartType,
                    data: {
                        labels: Object.keys(tenureBins),
                        datasets: [{
                            label: 'Workforce Mix',
                            data: Object.values(tenureBins),
                            backgroundColor: ['#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            datalabels: {
                                color: '#fff',
                                font: { weight: 'bold' },
                                formatter: (value, ctx) => {
                                    const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(0) + '%' : '0%';
                                    return percentage;
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
                
                const analysisChartType = document.querySelector('#practice-heatmap-chart-type button.active').dataset.type;
                const hireCounts = {};
                const practices = new Set();
                const years = new Set();
                filteredConsultants.forEach(c => {
                    const joinDate = parseDate(c.joinDate);
                    if (joinDate && c.practice) {
                        const year = joinDate.getFullYear().toString();
                        const practice = c.practice;
                        practices.add(practice);
                        years.add(year);
                        const key = `${year}-${practice}`;
                        hireCounts[key] = (hireCounts[key] || 0) + 1;
                    }
                });

                const sortedYears = [...years].sort();
                const sortedPractices = [...practices].sort();
                
                if(practiceHeatmapInstance) practiceHeatmapInstance.destroy();
                const analysisCtx = document.getElementById('practice-heatmap-chart').getContext('2d');

                const analysisData = [];
                for (const key in hireCounts) {
                    const [year, practice] = key.split('-');
                    analysisData.push({ x: year, y: practice, v: hireCounts[key] });
                }
                
                if (analysisChartType === 'matrix') {
                     practiceHeatmapInstance = new Chart(analysisCtx, {
                         type: 'matrix',
                         data: {
                             datasets: [{
                                 label: 'Hires by Practice/Year',
                                 data: analysisData,
                                 backgroundColor: (ctx) => {
                                     if (!ctx.raw) return 'rgba(0,0,0,0.1)';
                                     const value = ctx.raw.v;
                                     const alpha = value > 0 ? 0.2 + (value / 10) : 0.1;
                                     return `rgba(255, 99, 132, ${Math.min(alpha, 1)})`;
                                 },
                                 borderColor: 'rgba(0,0,0,0.5)',
                                 borderWidth: 1,
                                 width: ({chart}) => (chart.chartArea || {}).width / sortedYears.length - 1,
                                 height: ({chart}) => (chart.chartArea || {}).height / sortedPractices.length - 1
                             }]
                         },
                         options: {
                             responsive: true, maintainAspectRatio: false,
                             scales: {
                                 y: { type: 'category', labels: sortedPractices, offset: true, grid: { display: false } },
                                 x: { type: 'category', labels: sortedYears, offset: true, grid: { display: false } }
                             },
                             plugins: {
                                 legend: { display: false },
                                 tooltip: {
                                     callbacks: {
                                         title: () => '',
                                         label: (ctx) => [`Practice: ${ctx.raw.y}`,`Year: ${ctx.raw.x}`, `Hires: ${ctx.raw.v}`]
                                     }
                                 },
                                 datalabels: {
                                     color: (ctx) => (ctx.dataset.data[ctx.dataIndex]?.v > 5 ? 'white' : 'black'),
                                     display: (ctx) => ctx.dataset.data[ctx.dataIndex]?.v > 0,
                                     formatter: (ctx) => ctx.v,
                                     font: { weight: 'bold' }
                                 }
                             }
                         },
                         plugins: [ChartDataLabels]
                     });
                } else if (analysisChartType === 'bubble') {
                    practiceHeatmapInstance = new Chart(analysisCtx, {
                        type: 'bubble',
                        data: {
                            datasets: [{
                                label: 'Hires',
                                data: analysisData.map(d => ({ x: d.x, y: d.y, r: d.v * 5 })),
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: {
                                y: { type: 'category', labels: sortedPractices, offset: true },
                                x: { type: 'category', labels: sortedYears, offset: true }
                            },
                            plugins: {
                                tooltip: { callbacks: { label: (ctx) => `Hires: ${ctx.raw.r / 5}` } },
                                datalabels: { display: false }
                            }
                        }
                    });
                } else {
                    const colors = ['#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF6384', '#FF9F40'];
                    const barDatasets = sortedPractices.map((practice, i) => {
                        return {
                            label: practice,
                            data: sortedYears.map(year => hireCounts[`${year}-${practice}`] || 0),
                            backgroundColor: colors[i % colors.length]
                        };
                    });

                    practiceHeatmapInstance = new Chart(analysisCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedYears,
                            datasets: barDatasets
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: {
                                x: { stacked: true },
                                y: { stacked: true, beginAtZero: true }
                            },
                            plugins: {
                                datalabels: { display: false }
                            }
                        }
                    });
                }
            }

            /* --- TIMELINE VIEW FUNCTIONS --- */
            
            function renderTimelineView(isUpdate = false) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const timelineData = filteredConsultants;

                if (!isUpdate) {
                    populateGanttFilterDropdowns(allConsultants);
                    setupGanttEventListeners();
                }

                renderGanttChart(timelineData);
            }
            
            function populateGanttFilterDropdowns(data) {
                const buPractices = new Set(), managers = new Set(), consultants = new Set(), projects = new Set(), clients = new Set();
                data.forEach(consultant => {
                    if (consultant.businessUnit && consultant.practice) buPractices.add(`${consultant.businessUnit.trim()} - ${consultant.practice.trim()}`);
                    if(consultant.directManager) managers.add(consultant.directManager.trim());
                    if (consultant.consultantName) consultants.add(consultant.consultantName.trim());
                    parseProjectHistory(consultant.projectHistoryStr).forEach(p => {
                        if (p.project) projects.add(p.project.trim());
                        if (p.client) clients.add(p.client.trim());
                    });
                });
                const initSelect2 = (el, data, placeholder) => el.select2({ data: [...data].sort(), placeholder, closeOnSelect: false });
                initSelect2($('#filter-bu-practice'), buPractices, "Any BU/Practice...");
                initSelect2($('#filter-manager'), managers, "Any manager...");
                initSelect2($('#filter-consultant'), consultants, "Any consultant...");
                initSelect2($('#filter-project'), projects, "Any project...");
                initSelect2($('#filter-client'), clients, "Any client...");
            }

            function setupGanttEventListeners() {
                $('#timeline-view select').on('change', applyGanttFilters);
                $('#resetTimelineFilters').on('click', () => {
                    $('#timeline-view select').val(null).trigger('change');
                    document.querySelectorAll('.gantt-filter-cb').forEach(cb => {
                        cb.checked = true;
                        cb.dispatchEvent(new Event('change'));
                    });
                    applyGanttFilters();
                });
                
                document.querySelectorAll('.gantt-filter-cb').forEach(cb => {
                    cb.addEventListener('change', () => {
                        document.getElementById('gantt-chart-container').classList.toggle(`hide-${cb.value}`, !cb.checked);
                    });
                });
                
                const container = document.getElementById('gantt-chart-container');
                container.addEventListener('click', e => {
                    const summary = e.target.closest('.gantt-group-summary');
                    if (summary) {
                        const isCollapsed = summary.classList.toggle('collapsed');
                        const contentId = summary.dataset.toggles;
                        document.querySelectorAll(`[data-content-id="${contentId}"]`).forEach(el => {
                            el.style.display = isCollapsed ? 'none' : 'grid';
                        });
                    }
                });
                container.addEventListener('mouseover', e => {
                    const labelCell = e.target.closest('.gantt-label-cell');
                    if (labelCell) {
                        const consultantId = labelCell.parentElement.dataset.consultantId;
                        document.querySelectorAll(`[data-consultant-id="${consultantId}"]`).forEach(el => el.classList.add('gantt-row-highlight'));
                    }
                });
                container.addEventListener('mouseout', e => {
                    const labelCell = e.target.closest('.gantt-label-cell');
                    if (labelCell) {
                        document.querySelectorAll('.gantt-row-highlight').forEach(el => el.classList.remove('gantt-row-highlight'));
                    }
                });
            }
            
            function applyGanttFilters() {
                const selectedBuPractices = $('#filter-bu-practice').val(), selectedManagers = $('#filter-manager').val(), selectedConsultants = $('#filter-consultant').val();
                const selectedProjects = $('#filter-project').val(), selectedClients = $('#filter-client').val();
                const projectOrClientFilterActive = selectedProjects.length > 0 || selectedClients.length > 0;

                document.querySelectorAll('#timeline-view .gantt-label-row').forEach(row => {
                    const consultantId = row.dataset.consultantId;
                    const timelineRow = document.querySelector(`#timeline-view .timeline-row[data-consultant-id="${consultantId}"]`);
                    if (!timelineRow) return;
                    
                    const buPracticeMatch = selectedBuPractices.length === 0 || selectedBuPractices.includes(row.dataset.buPractice);
                    const managerMatch = selectedManagers.length === 0 || selectedManagers.includes(row.dataset.manager);
                    const consultantMatch = selectedConsultants.length === 0 || selectedConsultants.includes(row.dataset.consultantName);
                    
                    let projectMatch = false;
                    if (projectOrClientFilterActive) {
                        timelineRow.querySelectorAll('.gantt-bar[data-item-type="project"]').forEach(bar => {
                            const pMatch = selectedProjects.length === 0 || selectedProjects.includes(bar.dataset.projectName);
                            const cMatch = selectedClients.length === 0 || selectedClients.includes(bar.dataset.clientName);
                            if (pMatch && cMatch) projectMatch = true;
                        });
                    }
                    
                    const showRow = buPracticeMatch && managerMatch && consultantMatch && (!projectOrClientFilterActive || projectMatch);
                    row.classList.toggle('text-filter-hidden', !showRow);
                    timelineRow.classList.toggle('text-filter-hidden', !showRow);
                    
                    if (showRow) {
                        timelineRow.querySelectorAll('.gantt-bar[data-item-type="project"]').forEach(bar => {
                            const showBar = (selectedProjects.length === 0 || selectedProjects.includes(bar.dataset.projectName)) && (selectedClients.length === 0 || selectedClients.includes(bar.dataset.clientName));
                            bar.classList.toggle('text-filter-hidden', !showBar);
                        });
                    }
                });
            }
            
            function renderGanttChart(consultants) {
                const container = document.getElementById('gantt-chart-container');
                const today = new Date(); today.setHours(0,0,0,0);
                const groupedData = {};
                consultants.forEach(c => {
                    if (!c.consultantName) return;
                    const groupKey = `${c.practice || 'N/A'}`;
                    if (!groupedData[groupKey]) groupedData[groupKey] = [];
                    groupedData[groupKey].push(c);
                });

                let maxLanesGlobal = 1;
                consultants.forEach(c => {
                    const items = [ ...parseProjectHistory(c.projectHistoryStr).map(p => ({...p, type:'project'})), ...parseVacations(c.vacationStr).map(v => ({...v, type:'vacation', startDate: v.start, endDate: v.end})) ].filter(i => i.startDate && i.endDate).sort((a,b) => a.startDate - b.startDate);
                    if (items.length > 0) {
                        const lanes = [];
                        items.forEach(item => {
                            let placed = false;
                            for (let i = 0; i < lanes.length; i++) { if (item.startDate >= lanes[i]) { lanes[i] = item.endDate; placed = true; break; } }
                            if (!placed) lanes.push(item.endDate);
                        });
                        if (lanes.length > maxLanesGlobal) maxLanesGlobal = lanes.length;
                    }
                });
                
                const singleLaneHeight = 38;
                const uniformRowHeight = Math.max(70, maxLanesGlobal * singleLaneHeight);

                const allDates = consultants.flatMap(c => [...parseProjectHistory(c.projectHistoryStr), ...parseVacations(c.vacationStr).map(v=>({startDate:v.start, endDate:v.end}))]).flatMap(i => [i.startDate, i.endDate]).filter(d => d && !isNaN(d));
                const minDate = allDates.length > 0 ? new Date(Math.min(...allDates)) : new Date(today.getFullYear(), 0, 1);
                const maxDate = allDates.length > 0 ? new Date(Math.max(...allDates)) : new Date(today.getFullYear(), 11, 31);
                const chartStartDate = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
                const chartEndDate = new Date(maxDate.getFullYear(), maxDate.getMonth() + 1, 0);
                const totalDays = (chartEndDate - chartStartDate) / (1000 * 60 * 60 * 24);

                let monthHeaderHtml = '';
                const monthDiff = (chartEndDate.getFullYear() - chartStartDate.getFullYear()) * 12 + chartEndDate.getMonth() - chartStartDate.getMonth() + 1;
                for (let i = 0; i < monthDiff; i++) {
                    const monthDate = new Date(chartStartDate); monthDate.setMonth(monthDate.getMonth() + i);
                    monthHeaderHtml += `<div class="gantt-month-label h-full flex items-center justify-center font-semibold text-sm text-gray-600">${monthDate.toLocaleString('default', { month: 'long' })} ${monthDate.getFullYear()}</div>`;
                }
                const todayLineLeft = ((today - chartStartDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                const todayLineHtml = (todayLineLeft >= 0 && todayLineLeft <= 100) ? `<div class="today-line" style="left: ${todayLineLeft}%;"><div class="today-label">Today</div></div>` : '';

                let labelsHtml = '', rowsHtml = '';
                let rowIndex = 0;
                Object.keys(groupedData).sort().forEach(groupKey => {
                    const groupId = `group-${groupKey.replace(/\W/g, '-')}`;
                    labelsHtml += `<div class="gantt-group-summary collapsed" data-toggles="${groupId}">
                               <svg class="w-4 h-4 mr-2 arrow text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                               ${groupKey}
                           </div>`;
                    rowsHtml += `<div class="timeline-row gantt-group-summary" style="height: 40px;"></div>`;
                    
                    let consultantLabels = '', consultantRows = '';
                    groupedData[groupKey].sort((a, b) => a.consultantName.localeCompare(b.consultantName)).forEach(consultant => {
                        const allItems = [...parseProjectHistory(consultant.projectHistoryStr).map(p => ({...p, type:'project'})), ...parseVacations(consultant.vacationStr).map(v => ({...v, type:'vacation', startDate: v.start, endDate: v.end})) ].filter(i => i.startDate && i.endDate).sort((a, b) => a.startDate - b.startDate);
                        
                        const lanes = [], itemLanes = new Map();
                        allItems.forEach(item => {
                            let placed = false;
                            for (let i = 0; i < lanes.length; i++) { if (item.startDate >= lanes[i]) { lanes[i] = item.endDate; itemLanes.set(item, i); placed = true; break; } }
                            if (!placed) { lanes.push(item.endDate); itemLanes.set(item, lanes.length - 1); }
                        });
                        
                        const barHeight = 28, barTopPadding = 5;
                        const dataAttrs = `data-consultant-id="${consultant.dmeId}" data-consultant-name="${consultant.consultantName}" data-bu-practice="${groupKey}" data-manager="${consultant.directManager}"`;
                        const rowClass = rowIndex % 2 !== 0 ? 'gantt-row-odd' : '';
                        const imageSrc = getDirectImageLink(consultant.imageLink);
                        const safePlaceholderSVG = placeholderSVG.replace(/"/g, '&quot;');
                        
                        consultantLabels += `<div class="gantt-label-row ${rowClass}" style="height: ${uniformRowHeight}px;" ${dataAttrs}>
                            <div class="gantt-label-cell">
                                <img src="${imageSrc}" class="w-10 h-10 rounded-full mr-3 object-cover" onerror="this.src='data:image/svg+xml;base64,${btoa(placeholderSVG)}'">
                                <div>
                                    <a href="#consultant-card-${consultant.dmeId}" target="_blank" class="font-semibold text-indigo-600 hover:underline">${consultant.consultantName}</a>
                                    <div class="text-xs text-gray-500">${consultant.practice}</div>
                                </div>
                            </div>
                        </div>`;

                        let barsHtml = '';
                        let availabilityStart = parseDate(consultant.availabilityStartDate);
                        if (consultant.availabilityStartDate?.toLowerCase() === 'immediate') availabilityStart = new Date(today);
                        if (availabilityStart && availabilityStart < chartEndDate) {
                            const left = ((Math.max(availabilityStart, chartStartDate) - chartStartDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                            const width = ((chartEndDate - Math.max(availabilityStart, chartStartDate)) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                            barsHtml += `<div class="gantt-bar gantt-bar-available" style="left: ${left}%; width: ${width}%;" title="Available from ${availabilityStart.toLocaleDateString('en-GB')}" data-item-type="availability"></div>`;
                        }
                        
                        allItems.forEach(item => {
                            const start = Math.max(item.startDate, chartStartDate), end = Math.min(item.endDate, chartEndDate);
                            if (start >= end) return;
                            const left = ((start - chartStartDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                            const width = ((end - start) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                            const topPosition = (itemLanes.get(item) * singleLaneHeight) + barTopPadding;
                            
                            let barClass = '', tooltipText = '', displayText = '', itemDataAttrs = '';
                            if (item.type === 'project') {
                                if (item.status?.toLowerCase() === 'completed') barClass = 'gantt-bar-completed';
                                else if (item.startDate > today) barClass = 'gantt-bar-planned'; else barClass = 'gantt-bar-ongoing';
                                tooltipText = `Project: ${item.project}\nClient: ${item.client}\nPeriod: ${item.period}\nRole: ${item.role}`;
                                displayText = `${item.project} @ ${item.client}`;
                                itemDataAttrs = `data-project-name="${item.project}" data-client-name="${item.client}"`;
                            } else {
                                barClass = 'gantt-bar-vacation';
                                tooltipText = `Vacation: ${item.startDate.toLocaleDateString('en-GB')} to ${item.endDate.toLocaleDateString('en-GB')}`;
                                displayText = 'Vacation';
                            }
                            barsHtml += `<div class="gantt-bar ${barClass}" style="left: ${left}%; width: ${width}%; top: ${topPosition}px; height: ${barHeight}px;" title="${tooltipText}" data-item-type="${item.type}" ${itemDataAttrs}>${displayText}</div>`;
                        });
                        consultantRows += `<div class="timeline-row ${rowClass}" ${dataAttrs} style="height: ${uniformRowHeight}px;">${barsHtml}</div>`;
                        rowIndex++;
                    });

                    labelsHtml += `<div data-content-id="${groupId}" style="display: none;">${consultantLabels}</div>`;
                    rowsHtml += `<div data-content-id="${groupId}" style="display: none;">${consultantRows}</div>`;
                });

                container.innerHTML = `
                    <div class="gantt-grid">
                        <div class="gantt-labels">
                            <div class="gantt-header p-2 font-bold text-sm text-gray-700">Consultant</div>
                            ${labelsHtml}
                        </div>
                        <div class="gantt-rows">
                            <div class="gantt-timeline-header" style="height: 50px;">
                                <div class="gantt-header-months h-full" style="grid-template-columns: repeat(${monthDiff}, 1fr);">${monthHeaderHtml}</div>
                            </div>
                            <div class="relative w-full h-full">
                                ${todayLineHtml}
                                ${rowsHtml}
                            </div>
                        </div>
                    </div>
                `;

                const chartContainer = document.getElementById('gantt-chart-container');
                const todayLine = chartContainer.querySelector('.today-line');
                if (todayLine) {
                    const timelineWidth = chartContainer.querySelector('.gantt-rows').scrollWidth;
                    const todayPercentage = parseFloat(todayLine.style.left);
                    const scrollPosition = (todayPercentage / 100) * timelineWidth - (chartContainer.clientWidth / 3);
                    chartContainer.scrollLeft = scrollPosition;
                }
            }

            /* --- RECOMMENDER VIEW FUNCTIONS --- */
            
            function renderRecommenderView() {
                if (recommenderView.innerHTML.trim() !== '') return;

                recommenderView.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center gap-4">
                            <h2 class="text-3xl font-bold text-gray-800">Project Team Recommender</h2>
                            <button id="show-recommender-info" class="flex items-center gap-2 text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition-colors group">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 opacity-75 group-hover:opacity-100 animate-pulse group-hover:animate-none">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-7-4a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM9 9a1 1 0 0 0 0 2v3a1 1 0 0 0 1 1h1a1 1 0 1 0 0-2v-3a1 1 0 0 0-1-1H9Z" clip-rule="evenodd" />
                                </svg>
                                How this Works
                            </button>
                        </div>
                        <p class="mt-2 text-gray-600">Define your project's roles and requirements below. The tool will analyze the entire pool to recommend optimal teams, individual matches, and highlight any staffing gaps.</p>
                        
                        <div id="requirements-container" class="mt-8 space-y-4"></div>

                        <div class="mt-6 flex items-center gap-4">
                             <button id="add-requirement-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">
                                Add Role Requirement
                            </button>
                             <button id="find-teams-btn" class="btn-gradient font-bold py-2 px-4 rounded-lg transition duration-300">
                                Find Optimal Teams
                            </button>
                            <button id="download-recommender-pdf-btn" class="hidden bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-300">
                                Download Report as PDF
                            </button>
                        </div>
                        
                        <div id="recommender-output" class="hidden mt-8 space-y-8">
                            <div id="recommender-teams-output" class="recommender-output-section"></div>
                            <div id="recommender-individuals-output" class="recommender-output-section"></div>
                            <div id="recommender-gaps-output" class="recommender-output-section"></div>
                        </div>
                    </div>
                `;
                addRequirementCard();
                
                const infoModal = document.getElementById('recommender-info-modal');
                recommenderView.addEventListener('click', (e) => {
                    const link = e.target.closest('.consultant-link');
                    if (link) {
                        e.preventDefault();
                        const consultantId = link.dataset.id;
                        switchView('list');
                        setTimeout(() => {
                            const card = document.getElementById(`consultant-card-${consultantId}`);
                            if (card) {
                                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                card.style.transition = 'all 0.3s ease';
                                card.style.boxShadow = '0 0 0 3px rgba(79, 70, 229, 0.7)';
                                setTimeout(() => { card.style.boxShadow = ''; }, 2500);
                            }
                        }, 100);
                    }
                    if (e.target.id === 'add-requirement-btn') addRequirementCard();
                    if (e.target.id === 'find-teams-btn') runRecommender();
                    if (e.target.id === 'download-recommender-pdf-btn') generateRecommenderPDF();
                    if (e.target.id === 'show-recommender-info') {
                        infoModal.classList.remove('hidden');
                        infoModal.classList.add('flex');
                    }
                });
                
                infoModal.querySelector('#modal-info-close-btn').addEventListener('click', () => {
                    infoModal.classList.add('hidden');
                    infoModal.classList.remove('flex');
                });
                infoModal.addEventListener('click', (e) => {
                     if (e.target === infoModal) {
                        infoModal.classList.add('hidden');
                        infoModal.classList.remove('flex');
                     }
                });
            }
            
            let requirementIdCounter = 0;
            function addRequirementCard() {
                const container = document.getElementById('requirements-container');
                if (!container) return;

                container.querySelectorAll('details').forEach(d => d.removeAttribute('open'));
                
                requirementIdCounter++;
                const card = document.createElement('div');
                card.className = 'requirement-card bg-slate-50 rounded-lg shadow-sm border-l-4 border-indigo-500 overflow-hidden';
                card.innerHTML = `
                    <details open>
                        <summary class="requirement-card-summary p-4">
                             <div class="flex items-center gap-x-3">
                                 <span class="icon text-gray-500">
                                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>
                                 </span>
                                 <h4 class="text-lg font-bold text-gray-800">Role Requirement #${requirementIdCounter}</h4>
                             </div>
                             <button class="remove-requirement-btn text-gray-400 hover:text-red-600" title="Remove Requirement">&times;</button>
                        </summary>
                        <div class="p-6 pt-4 border-t border-slate-200">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Role Title</label>
                                    <input type="text" class="req-role-title mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., Data Architect">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Grade</label>
                                    <select class="req-grade mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Min. Experience (Years)</label>
                                    <input type="number" class="req-experience mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" value="0" min="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Start Date <span class="text-red-500">*</span></label>
                                    <input type="date" class="req-start-date mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">End Date <span class="text-red-500">*</span></label>
                                    <input type="date" class="req-end-date mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Utilization (%)</label>
                                    <input type="number" class="req-utilization mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" value="100" min="0" max="100">
                                </div>
                                <div class="col-span-1 md:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700">Required Capabilities</label>
                                    <select class="req-capabilities w-full" multiple="multiple"></select>
                                </div>
                                <div class="col-span-1 md:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700">Required Value Propositions</label>
                                    <select class="req-vps w-full" multiple="multiple"></select>
                                    <div class="req-vp-sliders-container mt-4 space-y-3"></div>
                                </div>
                                 <div class="col-span-1 md:col-span-3">
                                    <label class="block text-sm font-medium text-gray-700">Required Client / Project History (optional)</label>
                                    <input type="text" class="req-history mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., Bank ABC, Payments Project">
                                </div>
                            </div>
                        </div>
                    </details>
                `;
                container.appendChild(card);

                const titleInput = card.querySelector('.req-role-title');
                const titleHeader = card.querySelector('h4');
                const baseTitle = titleHeader.textContent;
                titleInput.addEventListener('input', () => {
                    if (titleInput.value.trim()) {
                        titleHeader.textContent = `${baseTitle} for ${titleInput.value.trim()}`;
                    } else {
                        titleHeader.textContent = baseTitle;
                    }
                });
                
                card.querySelector('.remove-requirement-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    card.remove();
                });

                const startDateInput = card.querySelector('.req-start-date');
                const endDateInput = card.querySelector('.req-end-date');
                startDateInput.addEventListener('input', () => {
                    if (startDateInput.value) {
                        endDateInput.min = startDateInput.value;
                        endDateInput.value = startDateInput.value;
                    }
                });

                const gradeOptions = [...new Set(allConsultants.map(c => c.grade).filter(Boolean))].sort();
                const gradeSelectEl = card.querySelector('.req-grade');
                gradeSelectEl.innerHTML = '<option value="">Any</option>' + gradeOptions.map(g => `<option value="${g}">${g}</option>`).join('');

                const capOptions = [...new Set(allConsultants.flatMap(c => (c.profileCapabilities || '').split(';')).map(s => s.trim()).filter(Boolean))].sort();
                const capSelectEl = $(card.querySelector('.req-capabilities'));
                capSelectEl.select2({ data: capOptions, placeholder: 'Select capabilities...', closeOnSelect: false, width: '100%' });

                const vpOptions = [...new Set(allConsultants.flatMap(c => (c.vpFit || '').split(';')).map(item => (item.trim().match(/(.*?)\s*\(\d+%\)/) || [])[1]).filter(Boolean))].sort();
                const vpSelectEl = $(card.querySelector('.req-vps'));
                vpSelectEl.select2({ data: vpOptions, placeholder: 'Select VPs...', closeOnSelect: false, width: '100%' });
                
                vpSelectEl.on('change', () => renderRequirementVPSliders(card));
            }
            
            function renderRequirementVPSliders(card) {
                const container = card.querySelector('.req-vp-sliders-container');
                const selectedVPs = $(card.querySelector('.req-vps')).val() || [];
                container.innerHTML = '';
                if (selectedVPs.length === 0) return;

                selectedVPs.forEach(vpName => {
                    const filterRow = document.createElement('div');
                    filterRow.className = 'text-sm';
                    const uniqueId = `req-vp-score-${vpName.replace(/[^a-zA-Z0-9]/g, '-')}-${requirementIdCounter}`;
                    filterRow.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                            <label for="${uniqueId}" class="text-gray-600 truncate pr-2">${vpName}</label>
                            <span id="${uniqueId}-display" class="font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-md">0%</span>
                        </div>
                        <input type="range" min="0" max="100" value="0" id="${uniqueId}" data-vp-name="${vpName}"
                               class="req-vp-score-input w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    `;
                    container.appendChild(filterRow);
                });

                container.querySelectorAll('.req-vp-score-input').forEach(slider => {
                    slider.addEventListener('input', (e) => {
                        const display = document.getElementById(`${e.target.id}-display`);
                        if (display) display.textContent = `${e.target.value}%`;
                    });
                });
            }

            function runRecommender() {
                const requirementCards = document.querySelectorAll('#requirements-container .requirement-card');
                const requirements = [];
                let hasErrors = false;
                
                requirementCards.forEach((card, index) => {
                    const startDate = card.querySelector('.req-start-date').value;
                    const endDate = card.querySelector('.req-end-date').value;
                    
                    if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) {
                        alert(`Error in Role Requirement #${index + 1}: Please enter valid start and end dates where the end date is not before the start date.`);
                        hasErrors = true;
                    }

                    const vpRequirements = [];
                    card.querySelectorAll('.req-vp-score-input').forEach(input => {
                        vpRequirements.push({
                            name: input.dataset.vpName,
                            score: parseInt(input.value, 10) || 0
                        });
                    });

                    requirements.push({
                        id: index,
                        title: card.querySelector('.req-role-title').value || `Role ${index + 1}`,
                        grade: card.querySelector('.req-grade').value,
                        experience: parseInt(card.querySelector('.req-experience').value, 10),
                        startDate: new Date(startDate),
                        endDate: new Date(endDate),
                        utilization: parseInt(card.querySelector('.req-utilization').value, 10),
                        capabilities: $(card.querySelector('.req-capabilities')).val(),
                        vpRequirements: vpRequirements,
                        history: card.querySelector('.req-history').value.toLowerCase().trim()
                    });
                });

                if (hasErrors) return;

                const allMatches = requirements.map(req => {
                    const matches = findMatchesForRequirement(req);
                    return { requirement: req, matches: matches };
                });

                const optimalTeams = findOptimalTeams(allMatches);
                
                lastRequirements = requirements;
                lastRecommenderResults = { allMatches, optimalTeams };
                
                renderRecommenderOutput(allMatches, optimalTeams);
            }
            
            function findMatchesForRequirement(req) {
                 const matches = allConsultants.filter(c => {
                    if (c.employmentStage !== 'Active - Stable') return false;

                    const consultantAvailDate = parseDate(c.availabilityStartDate);
                    if (c.availabilityStartDate?.toLowerCase() !== 'immediate' && (!consultantAvailDate || consultantAvailDate > req.startDate)) return false;

                    const vacations = parseVacations(c.vacationStr);
                    const hasConflict = vacations.some(v => (v.start <= req.endDate && v.end >= req.startDate));
                    if(hasConflict) return false;

                    if (req.grade && c.grade !== req.grade) return false;
                    if (c.totalYrsOfExp < req.experience) return false;
                    const consultantCaps = (c.profileCapabilities || '').toLowerCase();
                    if (req.capabilities && !req.capabilities.every(cap => consultantCaps.includes(cap.toLowerCase()))) return false;
                    if (req.history && !(c.projectHistoryStr || '').toLowerCase().includes(req.history)) return false;
                    
                    if (req.vpRequirements.length > 0) {
                        const consultantVPs = (c.vpFit || '').split(';').map(item => {
                            const match = item.trim().match(/(.*?)\s*\((\d+)%\)/);
                            return match ? { name: match[1].trim(), score: parseInt(match[2], 10) } : null;
                        }).filter(Boolean);
                        const meetsAllVPReqs = req.vpRequirements.every(vpReq => {
                            return consultantVPs.some(cvp => cvp.name === vpReq.name && cvp.score >= vpReq.score);
                        });
                        if (!meetsAllVPReqs) return false;
                    }
                    
                    return true;
                }).map(c => {
                    const experienceBonus = (c.totalYrsOfExp - req.experience) * 5;
                    const historyBonus = (req.history && (c.projectHistoryStr || '').toLowerCase().includes(req.history)) ? 50 : 0;
                    const score = 100 + experienceBonus + historyBonus;

                    return {
                        consultant: c,
                        score: Math.round(score),
                        breakdown: {
                            base: 100,
                            experience: experienceBonus,
                            history: historyBonus
                        }
                    };
                 });
                
                return matches.sort((a, b) => b.score - a.score);
            }
            
            function analyzeGaps(req) {
                const failureReasons = {
                    status: 0, availability: 0, vacation: 0, grade: 0, experience: 0,
                    capabilities: 0, history: 0, vp: 0
                };
                allConsultants.forEach(c => {
                    if (c.employmentStage !== 'Active - Stable') { failureReasons.status++; return; }

                    const consultantAvailDate = parseDate(c.availabilityStartDate);
                    if (c.availabilityStartDate?.toLowerCase() !== 'immediate' && (!consultantAvailDate || consultantAvailDate > req.startDate)) { failureReasons.availability++; return; }

                    const vacations = parseVacations(c.vacationStr);
                    if (vacations.some(v => v.start <= req.endDate && v.end >= req.startDate)) { failureReasons.vacation++; return; }

                    if (req.grade && c.grade !== req.grade) { failureReasons.grade++; return; }
                    if (c.totalYrsOfExp < req.experience) { failureReasons.experience++; return; }
                    
                    const consultantCaps = (c.profileCapabilities || '').toLowerCase();
                    if (req.capabilities && !req.capabilities.every(cap => consultantCaps.includes(cap.toLowerCase()))) { failureReasons.capabilities++; return; }
                    
                    if (req.history && !(c.projectHistoryStr || '').toLowerCase().includes(req.history)) { failureReasons.history++; return; }
                    
                    if (req.vpRequirements.length > 0) {
                        const consultantVPs = (c.vpFit || '').split(';').map(item => {
                            const match = item.trim().match(/(.*?)\s*\((\d+)%\)/);
                            return match ? { name: match[1].trim(), score: parseInt(match[2], 10) } : null;
                        }).filter(Boolean);
                        const meetsAllVPReqs = req.vpRequirements.every(vpReq => consultantVPs.some(cvp => cvp.name === vpReq.name && cvp.score >= vpReq.score));
                        if (!meetsAllVPReqs) { failureReasons.vp++; return; }
                    }
                });
                return failureReasons;
            }

            function findOptimalTeams(allMatches) {
                let allTeams = [];
                function findTeamsRecursive(roleIndex, currentTeam, usedConsultantIds) {
                    if (roleIndex === allMatches.length) {
                        allTeams.push({ ...currentTeam });
                        return;
                    }
                    const { requirement, matches } = allMatches[roleIndex];
                    if (matches.length === 0) return;

                    for (const match of matches) {
                        const consultantId = match.consultant.dmeId;
                        if (!usedConsultantIds.has(consultantId)) {
                            const nextTeam = { ...currentTeam, [requirement.id]: { ...match, requirement: requirement } };
                            const nextUsed = new Set(usedConsultantIds).add(consultantId);
                            findTeamsRecursive(roleIndex + 1, nextTeam, nextUsed);
                        }
                    }
                }
                
                findTeamsRecursive(0, {}, new Set());

                const scoredTeams = allTeams.map(team => {
                    const teamMembers = Object.values(team).map(m => m.consultant);
                    let cohesionScore = 0;
                    if (teamMembers.length > 1) {
                        for (let i = 0; i < teamMembers.length; i++) {
                            for (let j = i + 1; j < teamMembers.length; j++) {
                                const projectsA = new Set(parseProjectHistory(teamMembers[i].projectHistoryStr).map(p => p.project.toLowerCase()));
                                if (projectsA.size === 0) continue;
                                const projectsB = new Set(parseProjectHistory(teamMembers[j].projectHistoryStr).map(p => p.project.toLowerCase()));
                                const commonProjects = [...projectsA].filter(p => projectsB.has(p));
                                cohesionScore += commonProjects.length * 20;
                            }
                        }
                    }
                    const totalMatchScore = Object.values(team).reduce((sum, match) => sum + match.score, 0);
                    const finalScore = totalMatchScore + cohesionScore;
                    return { team, finalScore, totalMatchScore, cohesionScore };
                });

                return scoredTeams.sort((a, b) => b.finalScore - a.finalScore).slice(0, 5);
            }

            function renderRecommenderOutput(allMatches, optimalTeams) {
                document.getElementById('recommender-output').classList.remove('hidden');
                document.getElementById('download-recommender-pdf-btn').classList.remove('hidden');

                const teamsContainer = document.getElementById('recommender-teams-output');
                const individualsContainer = document.getElementById('recommender-individuals-output');
                const gapsContainer = document.getElementById('recommender-gaps-output');
                
                let teamsHtml = '<h3 class="text-2xl font-bold text-gray-800 pb-2 mb-4">🏆 Optimal Team Recommendations</h3>';
                if(optimalTeams.length > 0) {
                     teamsHtml += '<div class="space-y-4">' + optimalTeams.map((scoredTeam, i) => `
                         <div class="border rounded-lg shadow-sm ${i === 0 ? 'bg-indigo-50 border-indigo-300' : 'bg-white'}">
                             <div class="p-4 border-b">
                                 <div class="flex justify-between items-center">
                                     <h4 class="text-xl font-bold text-gray-800">Team Recommendation #${i + 1}</h4>
                                     ${i === 0 ? '<span class="text-xs font-bold uppercase tracking-wider bg-indigo-600 text-white px-3 py-1 rounded-full">Top Pick</span>' : ''}
                                 </div>
                                 <div class="flex items-baseline gap-4 mt-1">
                                     <span class="text-2xl font-bold text-indigo-600">${scoredTeam.finalScore} pts</span>
                                     <span class="text-sm text-gray-600">(Match: ${scoredTeam.totalMatchScore} + Cohesion: ${scoredTeam.cohesionScore})</span>
                                 </div>
                             </div>
                             <div class="p-4">
                                 <ul class="space-y-3">
                                 ${Object.values(scoredTeam.team).map(match => `
                                     <li class="flex items-center gap-3">
                                         <div class="bg-slate-200 text-slate-600 text-xs font-bold w-12 h-12 flex-shrink-0 rounded-full flex items-center justify-center">${match.score}</div>
                                         <div>
                                             <a href="#" class="consultant-link font-bold text-indigo-600 hover:underline" data-id="${match.consultant.dmeId}">${match.consultant.consultantName}</a>
                                             <p class="text-sm text-gray-500">as <em>${match.requirement.title}</em></p>
                                         </div>
                                     </li>
                                 `).join('')}
                                 </ul>
                             </div>
                         </div>
                     `).join('') + '</div>';
                } else {
                     teamsHtml += '<p class="text-gray-500">Could not form any complete teams based on the requirements. Check individual matches and gaps below.</p>';
                }
                teamsContainer.innerHTML = teamsHtml;

                let individualsHtml = '<h3 class="text-2xl font-bold text-gray-800 pb-2 mb-4">👤 Best Individual Matches</h3>';
                individualsHtml += '<div class="space-y-6">' + allMatches.map(({requirement, matches}) => {
                     let matchesContent = '';
                     if (matches.length > 0) {
                         matchesContent = '<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">' + matches.slice(0, 6).map(m => {
                            let rationale = `Excellent fit based on a solid base score.`;
                            if (m.breakdown.experience > 0) rationale += ` Has ${m.breakdown.experience / 5} extra years of experience.`;
                            if (m.breakdown.history > 0) rationale += ` Strong relevance with matching project history.`;
                            
                            return `
                                 <div class="border rounded-lg bg-white shadow-sm overflow-hidden">
                                     <div class="p-4">
                                         <div class="flex justify-between items-start">
                                             <div>
                                                 <a href="#" class="consultant-link font-bold text-indigo-600 hover:underline" data-id="${m.consultant.dmeId}">${m.consultant.consultantName}</a>
                                                 <p class="text-xs text-gray-500">${m.consultant.grade}</p>
                                             </div>
                                             <div class="text-xl font-bold text-indigo-600">${m.score}</div>
                                         </div>
                                     </div>
                                     <div class="bg-slate-50 p-4 border-t text-xs">
                                         <p class="font-semibold mb-1">Score Breakdown:</p>
                                         <p>Base: ${m.breakdown.base} + Experience: ${m.breakdown.experience} + History: ${m.breakdown.history}</p>
                                         <p class="font-semibold mt-2 mb-1">Rationale:</p>
                                         <p class="text-gray-600">${rationale}</p>
                                     </div>
                                 </div>
                            `;
                         }).join('') + '</div>';
                     } else {
                         matchesContent = `<p class="text-sm text-gray-500">No internal consultants match this role's requirements.</p>`;
                     }
                    return `<div>
                        <h4 class="text-lg font-semibold text-indigo-700 mb-3">${requirement.title}</h4>
                        ${matchesContent}
                    </div>`;
                }).join('') + '</div>';
                individualsContainer.innerHTML = individualsHtml;

                const gaps = allMatches.filter(m => m.matches.length === 0);
                let gapsHtml = '<h3 class="text-2xl font-bold text-red-600 pb-2 mb-4">⚠️ Identified Gaps</h3>';
                 if (gaps.length > 0) {
                     gapsHtml += '<p class="mb-4">The following roles could not be filled from the internal talent pool. Here is a breakdown of why candidates were filtered out:</p>';
                     gapsHtml += '<div class="space-y-4">' + gaps.map(g => {
                        const reasons = analyzeGaps(g.requirement);
                        const reasonMap = {
                            status: "not 'Active - Stable'", availability: "availability date", vacation: "vacation conflict",
                            grade: "grade mismatch", experience: "experience requirement", capabilities: "capability mismatch",
                            history: "project history keyword", vp: "value proposition fit"
                        };
                        const sortedReasons = Object.entries(reasons).filter(([, count]) => count > 0).sort((a, b) => b[1] - a[1]);
                        let reasonText = 'No candidates in the pool.';
                        if (sortedReasons.length > 0) {
                            reasonText = `Top failure reasons: ` + sortedReasons.slice(0, 3).map(([key, count]) => `<strong>${count}</strong> failed ${reasonMap[key]}`).join(', ') + '.';
                        }
                        
                        return `
                              <div class="bg-red-50 border border-red-200 p-3 rounded-lg">
                                <p class="font-bold text-red-800">${g.requirement.title}</p>
                                <p class="text-sm text-red-700 mt-1">${reasonText}</p>
                              </div>
                            `;
                    }).join('') + '</div>';
                 } else {
                     gapsHtml += '<p class="text-green-700 font-semibold">✅ Great news! Potential candidates were found for all required roles.</p>';
                 }
                gapsContainer.innerHTML = gapsHtml;
            }

            function generateRecommenderPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let finalY = 20;

                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text('Project Team Recommendation Report', 15, finalY);
                finalY += 10;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Report generated on: ${new Date().toLocaleDateString()}`, 15, finalY);
                finalY += 15;
                
                const checkPageBreak = (currentY) => {
                    if (currentY > 260) {
                        doc.addPage();
                        return 20;
                    }
                    return currentY;
                };

                doc.setFontSize(18);
                doc.text('1. Project Requirements', 15, finalY);
                finalY += 8;

                lastRequirements.forEach((req, index) => {
                    finalY = checkPageBreak(finalY);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Role #${index + 1}: ${req.title}`, 15, finalY);
                    finalY += 6;
                    
                    const reqData = [
                        ['Grade', req.grade || 'Any'],
                        ['Min. Experience', `${req.experience} years`],
                        ['Project Dates', `${req.startDate.toLocaleDateString()} to ${req.endDate.toLocaleDateString()}`],
                        ['Utilization', `${req.utilization}%`],
                        ['Capabilities', req.capabilities.join(', ') || 'Any'],
                        ['VPs & Min Fit', req.vpRequirements.map(vp => `${vp.name} (${vp.score}%)`).join(', ') || 'Any'],
                        ['Client/Project History', req.history || 'Any']
                    ];

                    doc.autoTable({
                        startY: finalY,
                        head: [['Criteria', 'Value']],
                        body: reqData,
                        theme: 'grid',
                        headStyles: { fillColor: [79, 70, 229] }
                    });
                    finalY = doc.autoTable.previous.finalY + 10;
                });
                
                finalY = checkPageBreak(finalY);
                doc.setFontSize(18);
                doc.text('2. Optimal Team Recommendations', 15, finalY);
                finalY += 8;

                if (lastRecommenderResults.optimalTeams && lastRecommenderResults.optimalTeams.length > 0 && Object.keys(lastRecommenderResults.optimalTeams[0].team).length > 0) {
                     lastRecommenderResults.optimalTeams.forEach((scoredTeam, index) => {
                         finalY = checkPageBreak(finalY);
                         doc.setFontSize(12);
                         doc.setFont('helvetica', 'bold');
                         doc.text(`Recommendation #${index + 1} | Final Score: ${scoredTeam.finalScore} (Match: ${scoredTeam.totalMatchScore}, Cohesion: ${scoredTeam.cohesionScore})`, 15, finalY);
                         finalY += 6;

                         const teamBody = Object.values(scoredTeam.team).map(match => [
                            match.requirement.title,
                            match.consultant.consultantName,
                            match.score
                        ]);

                        doc.autoTable({
                            startY: finalY,
                            head: [['Role', 'Assigned Consultant', 'Match Score']],
                            body: teamBody,
                        });
                        finalY = doc.autoTable.previous.finalY + 10;
                    });
                } else {
                     doc.setFontSize(10);
                     doc.text('No complete teams could be formed from the available pool.', 15, finalY);
                     finalY += 10;
                }

                finalY = checkPageBreak(finalY);
                doc.setFontSize(18);
                doc.text('3. Best Individual Matches', 15, finalY);
                finalY += 8;
                
                lastRecommenderResults.allMatches.forEach(({requirement, matches}) => {
                    finalY = checkPageBreak(finalY);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Role: ${requirement.title}`, 15, finalY);
                    finalY += 6;

                    if (matches.length > 0) {
                        doc.autoTable({
                            startY: finalY,
                            head: [['Rank', 'Consultant', 'Match Score']],
                            body: matches.slice(0, 5).map((m, i) => [i + 1, m.consultant.consultantName, m.score]),
                        });
                        finalY = doc.autoTable.previous.finalY + 10;
                    } else {
                        doc.setFontSize(10);
                        doc.text('No internal matches found.', 17, finalY);
                        finalY += 8;
                    }
                });

                finalY = checkPageBreak(finalY);
                doc.setFontSize(18);
                doc.text('4. Identified Gaps', 15, finalY);
                finalY += 8;
                const gaps = lastRecommenderResults.allMatches.filter(m => m.matches.length === 0);
                 if (gaps.length > 0) {
                     doc.setFontSize(10);
                     gaps.forEach(g => {
                        doc.text(`• ${g.requirement.title}`, 17, finalY);
                        finalY += 6;
                    });
                 } else {
                     doc.setFontSize(10);
                     doc.text('No staffing gaps identified. Candidates were found for all roles.', 15, finalY);
                 }


                doc.save('Team_Recommendation_Report.pdf');
            }
            
            (async () => {
                const data = await fetchData();
                if (data.consultants && data.consultants.length > 0) {
                    initializeDashboard(data);
                    setupImageModal(); 
                }
            })();
        });
        
    </script>
</body>
</html>